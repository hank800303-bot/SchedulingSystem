<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>排班系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.24.9/babel.min.js" crossorigin></script>

  <!-- 仍保留做備用；主要用友善列印 -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Firebase（不含 analytics） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut, getIdTokenResult
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, onSnapshot, getDoc,
      collection, addDoc, serverTimestamp, getDocs, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";

    window.firebase = {
      initializeApp, getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut, getIdTokenResult,
      getFirestore, doc, setDoc, onSnapshot, getDoc,
      collection, addDoc, serverTimestamp, getDocs, query, where, limit,
      getFunctions, httpsCallable
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
    body { font-family:'Noto Sans TC',sans-serif; }
    .scrollbar-hide::-webkit-scrollbar { display:none; }
    .scrollbar-hide { -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo, useRef } = React;

    // 依舊順序 + 新名單合併：新員工永遠長在最右邊
    function mergeStableOrder(prev = [], names = []) {
      const setNew = new Set(names);
      const kept = prev.filter(n => setNew.has(n));
      const appended = names.filter(n => !kept.includes(n));
      return kept.concat(appended);
    }

    const {
      initializeApp, getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, getIdTokenResult,
      getFirestore, doc, setDoc, onSnapshot, getDoc,
      collection, addDoc, serverTimestamp, getDocs, query, where, limit,
      getFunctions, httpsCallable
    } = window.firebase;

    /* ===== 常數 ===== */
    const CODE_VERSION = '20250929-64';
    const APP_ID = 'zhenan-scheduler';
    const WORKSPACE_ID = 'main';
    const FUNCTIONS_REGION = 'asia-east1';
    const AUTO_SAVE_DELAY_MS = 1200;
    
    const firebaseConfig = {
      apiKey: "AIzaSyA0RjZ0RXst__qzv4e281LUOh2zdiMgmd0",
      authDomain: "zhenan-scheduler.firebaseapp.com",
      projectId: "zhenan-scheduler",
      storageBucket: "zhenan-scheduler.firebasestorage.app",
      messagingSenderId: "217165082111",
      appId: "1:217165082111:web:549c98dd09589029918bca"
    };

    // 班別循環（最後的 '' 代表空白）
    const SHIFT_OPTIONS = ['早班','早+午班','午班','午+晚班','晚班','全天','休','支援樹林','請假',''];
    const SHIFT_COLOR = {
      '早班':'bg-blue-200 text-blue-800',
      '早+午班':'bg-indigo-200 text-indigo-800',
      '午班':'bg-teal-200 text-teal-800',
      '午+晚班':'bg-purple-200 text-purple-800',
      '晚班':'bg-red-200 text-red-800',
      '全天':'bg-cyan-200 text-cyan-800',
      '休':'bg-gray-300 text-gray-800',
      '請假':'bg-rose-200 text-rose-800',
      '支援樹林':'bg-lime-200 text-lime-800',
      '': 'bg-white text-gray-500'
    };

    /* ===== 工具與時間規則 ===== */
    const toMin = (h,m=0)=> h*60+m;
    const fmtHM  = (min)=> `${String(Math.floor(min/60)).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
    const fmtHours = (mins)=> {
      const h=mins/60; return (Math.abs(h-Math.round(h))<1e-9)? `${Math.round(h)}小時` : `${(Math.round(h*2)/2).toFixed(1)}小時`;
    };
    const pad2 = (n)=> String(n).padStart(2,'0');
    const ymdLocal = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const ymLocal  = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const fmtYMDHM = (ts)=>{
      const d = (ts && ts.toDate) ? ts.toDate() : (ts instanceof Date ? ts : null);
      if(!d) return '—';
      const y = d.getFullYear(), m = pad2(d.getMonth()+1), da = pad2(d.getDate());
      const hh = pad2(d.getHours()), mm = pad2(d.getMinutes());
      return `${y}/${m}/${da} ${hh}:${mm}`;
    };
    const debounce = (fn,delay=500)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay);} };
    const getDaysInMonth = (y,m)=> new Date(y, m+1, 0).getDate();
    const getDowName = (y,m,d)=> ['日','一','二','三','四','五','六'][ new Date(y,m,d).getDay() ];

    // 營業時間
    const getBusinessWindow = (date)=>{
      const dow=date.getDay();
      if(dow===0) return { open:toMin(9,30), close:toMin(21,0) };
      if(dow===6) return { open:toMin(9,0),  close:toMin(21,0) };
      return { open:toMin(9,0),  close:toMin(22,0) };
    };

    const getShiftWindowForDate = (date, shiftText)=>{
      const { open, close } = getBusinessWindow(date);
      const cap = (s,e)=>({ start:Math.max(open,Math.min(s,close)), end:Math.max(Math.max(open,Math.min(s,close)), Math.min(e,close)) });
      if(!shiftText || shiftText==='休' || shiftText==='請假') return { label:'0 小時', hoursMin:0 };
      if(shiftText==='支援樹林') return { label:'', hoursMin:0 };
      let target;
      switch(shiftText){
        case '早班':    target={start:open,        end:open+toMin(4)}; break;
        case '早+午班': target={start:open,        end:toMin(17,0)};   break;
        case '午班':    target={start:toMin(13,0), end:toMin(17,0)};   break;
        case '午+晚班': target={start:toMin(13,0), end:close};         break;
        case '晚班':    target={start:toMin(16,0), end:close};         break;
        case '全天':    target={start:open,        end:close};         break;
        default:        target={start:open,        end:open};
      }
      const { start, end } = cap(target.start, target.end);
      const minutes = Math.max(0, end - start);
      const label = minutes>0 ? `${fmtHM(start)} - ${fmtHM(end)} (${fmtHours(minutes)})` : '0 小時';
      return { label, hoursMin: minutes };
    };

    const getShiftText = (v)=> (typeof v==='object' && v) ? '請假' : (v||'');

    /* === 行事曆 HTML（友善列印 / A4）=== */
    function buildCalendarHTML(y, mIndex0, staffs, schedule, exportmode = 'full'){
      const m = mIndex0 + 1;
      const esc = (s)=> String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const total = getDaysInMonth(y, mIndex0);
      const first = new Date(y, mIndex0, 1);
      const firstDowMonStart = (first.getDay() + 6) % 7; // Monday start

      const cells = [];
      for(let i=0;i<firstDowMonStart;i++) cells.push(null);
      for(let d=1; d<=total; d++) cells.push(d);
      while(cells.length % 7 !== 0) cells.push(null);

      const rows = Math.ceil(cells.length / 7);
      const bodyClass = rows >= 6 ? 'six-rows' : '';

      const renderDay = (d)=>{
        if(!d) return '';
        const items = [];
        for(let si=0; si<staffs.length; si++){
          const name = staffs[si];
          const v = (schedule && schedule[d-1] && schedule[d-1][si]) ?? '';
          const t = getShiftText(v);
          if(!t || t==='休' || t==='請假') continue;

          const tDisp = t.replace('早+午','早＋午').replace('午+晚','午＋晚');

          if (exportmode === 'full') {
            const info  = getShiftWindowForDate(new Date(y, mIndex0, d), t);
            const short = info.label ? (info.label.split(' (')[0] || '') : '';
            const line =
              '<div class="item">'
                + '<div class="row1"><span class="name">'+esc(name)+'</span> '+esc(tDisp)+'</div>'
                + (short ? '<div class="row2">'+esc(short)+'</div>' : '')
              + '</div>';
            items.push(line);
          } else {
            items.push('<div class="item"><span class="name">'+esc(name)+'</span>：'+esc(tDisp)+'</div>');
          }
        }
        return items.length ? items.join('') : '<div class="item empty">—</div>';
      };

      const cellHtml = cells.map(function(d){
        if(!d) return '<div class="cell"></div>';
        return ''
          + '<div class="cell">'
          +   '<div class="header"><span class="datepill">' + m + '/' + d + '</span><span></span></div>'
          +   renderDay(d)
          + '</div>';
      }).join('');

      const html =
      '<!doctype html><html lang="zh-TW"><head><meta charset="utf-8"/>'
      +'<meta name="viewport" content="width=device-width, initial-scale=1.0"/>'
      +'<title>'+ y + '年' + (String(m).padStart(2,"0")) + '月 班表</title>'
  +'<style>*{box-sizing:border-box}'
+  '@page{size:A4 landscape;margin:0}'  /* 列印邊界歸零 */
+  '@media print{*{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'
+  'html,body{margin:0;padding:0;background:#fff}'
+  /* 固定 A4 橫式內容區尺寸，自己留 10mm 內邊距 */
+  'body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Noto Sans TC",sans-serif;'
+       'width: calc(297mm - 20mm);'
+       'height: calc(210mm - 20mm);'
+       'padding:10mm;color:#111;overflow:hidden}'
+  /* 佈局與元件 */
+  'h1{margin:0 0 3.5mm;font-size:11pt}'
+  '.week{display:grid;grid-template-columns:repeat(7,1fr);gap:2mm;margin-bottom:1.6mm;'
+        'color:#6b7280;font-weight:600;text-align:center;font-size:9.5pt;'
+        'break-after:avoid-page;page-break-after:avoid}'
+  '.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1.8mm;'
+        'break-inside:auto;page-break-inside:auto}'
+  '.cell{min-height:28.5mm;border:0.3mm solid #e5e7eb;border-radius:2mm;padding:1.8mm}'
+  '.header{display:flex;align-items:center;justify-content:space-between}'
+  '.datepill{display:inline-block;font-size:9pt;color:#6b7280;border:0.3mm solid #e5e7eb;'
+            'border-radius:2mm;padding:0.5mm 2mm}'
+  '.item{margin-top:1mm}.item .row1{font-size:9.8pt;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}'
+  '.item .row2{font-size:8.4pt;color:#4b5563;margin-top:0.3mm}.empty{color:#c7c7c7;font-size:10pt}'
+  /* 避免被強制分頁 */
+  '.week,.grid,.cell{break-inside:avoid;page-break-inside:avoid}'
+  /* 六列月曆時微縮字距與間距 */
+  'body.six-rows h1{margin:0 0 3mm;font-size:10.5pt}'
+  'body.six-rows .week{margin-bottom:1.2mm;font-size:9pt}'
+  'body.six-rows .grid{gap:1.4mm}'
+  'body.six-rows .cell{min-height:25.5mm;padding:1.6mm}'
+  'body.six-rows .item .row1{font-size:9.2pt}'
+  'body.six-rows .item .row2{font-size:8pt}'
+'</style>'

    /* ===== App ===== */
    function App(){
      const [db,setDb] = useState(null);
      const [auth,setAuth] = useState(null);
      const [func,setFunc] = useState(null);
      const [user,setUser] = useState(null);

      const claimsRefreshedOnce = useRef(false);
      const [isAdmin,setIsAdmin] = useState(false);

      const [nameModalOpen, setNameModalOpen] = useState(false);
      const [pendingPunchType, setPendingPunchType] = useState(null); // 'IN' | 'OUT'

      const [currentDate,setCurrentDate] = useState(new Date());
      const [staffs,setStaffs] = useState([]);
      const [schedule,setSchedule] = useState([]);
      const [newStaffName,setNewStaffName] = useState('');
      const [statusMessage,setStatusMessage] = useState('');
      const [error,setError] = useState('');
      const [email,setEmail] = useState(localStorage.getItem('rememberedEmail')||'');
      const [password,setPassword] = useState('');
      const [rememberEmail,setRememberEmail] = useState(!!localStorage.getItem('rememberedEmail'));

      const [nameLocked, setNameLocked] = useState(false);
      const [confirmOpen,setConfirmOpen] = useState(false);
      const [staffToDel,setStaffToDel] = useState(null);

      const [myName,setMyName] = useState('');
      const [myTodayLogs,setMyTodayLogs] = useState([]);
      const [todayLatestIO,setTodayLatestIO] = useState([]);

      const [exportOpen,setExportOpen] = useState(false);
      const exportRef = useRef(null);
      const [exportMode, setExportMode] = useState('full'); // 'full' | 'simple'

      const [attOpen,setAttOpen] = useState(false);
      const [attLoading,setAttLoading] = useState(false);
      const [attRows,setAttRows] = useState([]);
      const attRef = useRef(null);

      const [logOpen, setLogOpen] = useState(false);
      const [logLoading, setLogLoading] = useState(false);
      const [logRows, setLogRows] = useState([]);
      const [logFilterName, setLogFilterName] = useState('');
      const [logFilterType, setLogFilterType] = useState('ALL'); // ALL | IN | OUT
      const logRef = useRef(null);

      // 儲存狀態
      const [saving, setSaving] = useState(false);
      // === 髒資料旗標＋自動存檔（避免每點一下就打 API） ===
const dirtyRef = useRef(false);
const autosaveTimerRef = useRef(null);

function markDirtyAndAutosave(latestSchedule) {
   dirtyRef.current = true;
  if (autosaveTimerRef.current) clearTimeout(autosaveTimerRef.current);
  autosaveTimerRef.current = setTimeout(() => {
    if (!dirtyRef.current) return;
    saveScheduleDebounced(latestSchedule);
    dirtyRef.current = false;
  }, AUTO_SAVE_DELAY_MS);
}

useEffect(() => {
  return () => { if (autosaveTimerRef.current) clearTimeout(autosaveTimerRef.current); };
}, []);

      // 管理員工具列
      const [adminTarget, setAdminTarget] = useState('');
      const [adminBusy, setAdminBusy] = useState(false);

      // 點格子冷卻：避免延遲造成過度連點
      const hotCellsRef = useRef(new Set()); // key: `${dayIndex}-${staffIndex}`

      const prevUidRef = useRef(null);
      useEffect(() => {
        const uid = user?.uid || null;
        if (prevUidRef.current !== uid) {
          setMyName('');
          setNameLocked(false);
          setMyTodayLogs([]);
          setTodayLatestIO([]);
          setExportOpen(false);
          setAttOpen(false);
          setPendingPunchType(null);
          setNameModalOpen(false);
          setLogOpen(false); setLogRows([]);
        }
        prevUidRef.current = uid;
      }, [user?.uid]);

      // Firebase 初始化 + 登入監聽
      useEffect(() => {
        const app   = initializeApp(firebaseConfig);
        const _db   = getFirestore(app);
        const _auth = getAuth(app);
        const _func = getFunctions(app, FUNCTIONS_REGION);
        setDb(_db); setAuth(_auth); setFunc(_func);
        window.func = _func;

        const unsub = onAuthStateChanged(_auth, async (cur) => {
          setUser(cur || null);
          if (!cur) { setIsAdmin(false); return; }

          try {
            const r1 = await cur.getIdTokenResult();
            let adminFlag = !!r1.claims?.admin;

            if (!adminFlag && !claimsRefreshedOnce.current) {
              claimsRefreshedOnce.current = true;
              await cur.getIdToken(true);
              const r2 = await cur.getIdTokenResult();
              adminFlag = !!r2.claims?.admin;
              window.lastClaims = r2.claims;
              console.log('claims(after refresh):', r2.claims);
            } else {
              window.lastClaims = r1.claims;
              console.log('claims:', r1.claims);
            }
            setIsAdmin(adminFlag);

            // 載入個人檔案
            try {
              const prefRef = doc(_db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/members/${cur.uid}`);
              const snap = await getDoc(prefRef);
              if (snap.exists()) {
                setMyName(snap.data().displayName || '');
                setNameLocked(!!snap.data().nameLocked);
              }
            } catch (e) {
              console.warn('load member profile fail', e);
            }
          } catch (e) {
            console.warn('getIdTokenResult failed', e);
            setIsAdmin(false);
          }
        });

        return () => unsub();
      }, []);

      /* 今日我的打卡（最近兩筆） */
      useEffect(()=>{
        (async ()=>{
          if(!db || !user){ setMyTodayLogs([]); return; }
          const dk = ymdLocal(new Date());
          try{
            const lref = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance/${dk}/logs`);
            const snap = await getDocs(lref);
            const list = snap.docs.map(d=>({ id:d.id, ...d.data() }))
                                  .filter(x=>x.uid===user.uid)
                                  .sort((a,b)=> (a.ts?.toMillis?.()||0)-(b.ts?.toMillis?.()||0));
            setMyTodayLogs(list.slice(-2));
          }catch(e){ console.warn('load my today logs fail', e); setMyTodayLogs([]); }
        })();
      },[db,user]);

      /* 今日所有人的最新 IN/OUT */
      const loadTodayLatestIO = async ()=>{
        if(!db || !user) return;
        const dk = ymdLocal(new Date());
        try{
          const lref = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance/${dk}/logs`);
          const snap = await getDocs(lref);
          const byUid = new Map();
          for(const docu of snap.docs){
            const d = docu.data();
            const cur = byUid.get(d.uid) || { uid:d.uid, displayName:d.displayName||'', email:d.email||'', inTs:null, outTs:null };
            if(d.ts?.toMillis){
              const ms = d.ts.toMillis();
              if(d.type==='IN'  && (!cur.inTs  || ms > cur.inTs.toMillis()))  cur.inTs  = d.ts;
              if(d.type==='OUT' && (!cur.outTs || ms > cur.outTs.toMillis())) cur.outTs = d.ts;
            }
            byUid.set(d.uid, cur);
          }
          setTodayLatestIO(Array.from(byUid.values()));
        }catch(e){
          console.error('load today latest IO fail:', e);
          setStatusMessage(`載入失敗：${e.code||e.message}`); setTimeout(()=>setStatusMessage(''),2000);
        }
      };
      useEffect(()=>{ if(db && user) loadTodayLatestIO(); }, [db,user]);

      /* 儲存我的姓名（首次儲存後即鎖定） */
      async function saveMyName(){
        if(!db || !user) return;
        if(nameLocked && (myName || '').trim()){
          setStatusMessage('姓名已鎖定，無法變更'); setTimeout(()=>setStatusMessage(''),1600);
          setNameModalOpen(false);
          setPendingPunchType(null);
          return;
        }
        const finalName = (myName || '').trim();
        if(!finalName){
          setStatusMessage('請先輸入姓名'); setTimeout(()=>setStatusMessage(''),1600);
          return;
        }
        try{
          const pref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/members/${user.uid}`);
          await setDoc(pref, {
            displayName: finalName, email: user.email||'', nameLocked: true, updatedAt: new Date()
          }, { merge:true });

          setMyName(finalName);
          setNameLocked(true);
          setStatusMessage('姓名已儲存並鎖定'); setTimeout(()=>setStatusMessage(''),1200);

          if (pendingPunchType) {
            const type = pendingPunchType;
            setPendingPunchType(null);
            setNameModalOpen(false);
            punch(type);
            return;
          }
          setNameModalOpen(false);
        }catch(e){
          console.error('save name fail', e);
          setStatusMessage(`儲存姓名失敗：${e.code||e.message}`); setTimeout(()=>setStatusMessage(''),2000);
        }
      }

      /* === 監看員工名單（保持新增於最右） === */
      const prevStaffsRef = useRef([]);
      useEffect(() => {
        if (!db || !user) return;
        const ref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/staffs/staffList`);
        return onSnapshot(ref, (snap) => {
          const names = snap.exists() ? (snap.data().names || []) : [];
          const safe = Array.isArray(names) ? names : [];
          const merged = mergeStableOrder(prevStaffsRef.current, safe);
          prevStaffsRef.current = merged;
          setStaffs(merged);
        }, (err) => {
          console.warn('watch staffList error', err);
          prevStaffsRef.current = [];
          setStaffs([]);
        });
      }, [db, user]);

      /* === 監看當月班表（欄位：schedule） === */
      useEffect(() => {
        if (!db || !user) return;
        const y = currentDate.getFullYear();
        const m = pad2(currentDate.getMonth() + 1);
        const ref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/schedules/${y}-${m}`);
        return onSnapshot(ref, (snap) => {
          if (!snap.exists()) { setSchedule([]); return; }
          const raw = snap.data().schedule ?? '[]';
          try {
            const grid = Array.isArray(raw) ? raw : JSON.parse(raw);
            setSchedule(Array.isArray(grid) ? grid : []);
          } catch (e) {
            console.warn('parse schedule fail', e);
            setSchedule([]);
          }
        }, (err) => {
          console.warn('watch schedule error', err);
          setSchedule([]);
        });
      }, [db, user, currentDate]);

      // ===== 直接把 identifier 丟給雲端，後端負責解析 =====
const callPromote = async (identifier) => {
  if (!func) throw new Error('Functions not ready');
  const r = await httpsCallable(func, 'promoteToAdmin')({
    identifier, workspaceId: WORKSPACE_ID
  });
  return r.data;
};
const callRevoke = async (identifier) => {
  if (!func) throw new Error('Functions not ready');
  const r = await httpsCallable(func, 'revokeAdmin')({
    identifier, workspaceId: WORKSPACE_ID
  });
  return r.data;
};
      const callAddStaff = async (name) => {
  if (!func) throw new Error('Functions not ready');
  const r = await httpsCallable(func, 'addStaff')({
    workspaceId: WORKSPACE_ID, name
  });
  return r.data;
};
const callRemoveStaff = async (name) => {
  if (!func) throw new Error('Functions not ready');
  const r = await httpsCallable(func, 'removeStaff')({
    workspaceId: WORKSPACE_ID, name
  });
  return r.data;
};
const callSaveSchedule = async (monthId, scheduleJson) => {
  if (!func) throw new Error('Functions not ready');
  const r = await httpsCallable(func, 'saveSchedule')({
    workspaceId: WORKSPACE_ID, monthId, schedule: scheduleJson
  });
  return r.data;
};

// 管理員工具列用（保留語意名稱）
async function promoteByInput(_db, _func, input) {
  return callPromote((input || '').trim());
}
async function revokeByInput(_db, _func, input) {
  return callRevoke((input || '').trim());
}

      /* 儲存班表（由 callable 寫入） */
      const sanitizeSchedule = (data)=>
        Array.isArray(data) ? data.map(row => Array.isArray(row) ? row.map(v => (v===undefined?'':v)) : []) : [];

      const saveScheduleDebounced = debounce(async (scheduleData)=>{
        if(!db || !user) return;
        try{
          setSaving(true);
          const y=currentDate.getFullYear(), m=currentDate.getMonth()+1, monthId=`${y}-${pad2(m)}`;
          await callSaveSchedule(monthId, JSON.stringify(sanitizeSchedule(scheduleData)));
          setStatusMessage('班表已儲存！'); setTimeout(()=>setStatusMessage(''),1000);
        }catch(e){
          console.error('save schedule fail', e);
          setStatusMessage(`儲存失敗：${e.code||e.message||e}`); setTimeout(()=>setStatusMessage(''),2000);
        }finally{
          setSaving(false);
        }
      }, 800); // 降低頻率

      const manualSave = ()=> saveScheduleDebounced(schedule);

      /* 點格子切換班別（循環 + 冷卻 250ms + 即時更新） */
      const handleShiftChange = (dayIndex, staffIndex) => {
        const ownerName = staffs[staffIndex];

        // 權限：只有管理員或本人可編輯
        if (!isAdmin) {
          if (!myName || ownerName !== myName) {
            setStatusMessage('你只能編輯自己的班表');
            setTimeout(() => setStatusMessage(''), 1200);
            return;
          }
        }

        // 點擊冷卻，避免延遲造成跳兩格
        const key = `${dayIndex}-${staffIndex}`;
        if (hotCellsRef.current.has(key)) return;
        hotCellsRef.current.add(key);
        setTimeout(() => {
          hotCellsRef.current.delete(key);
        }, 250);

        // 產生下一版
        const cols = staffs.length;
        const next = (schedule && schedule.slice()) || [];
        next[dayIndex] = Array.isArray(next[dayIndex]) ? next[dayIndex].slice() : Array(cols).fill('');

        const cur = next[dayIndex][staffIndex];
        const curText = (typeof cur === 'object') ? '請假' : (cur || '');
        const i = SHIFT_OPTIONS.indexOf(curText);
        const nextIndex = ((i >= 0 ? i : -1) + 1) % SHIFT_OPTIONS.length;
        const nextText = SHIFT_OPTIONS[nextIndex];

        next[dayIndex][staffIndex] =
          nextText === '請假'
            ? { shift: '請假', type: '未備註', days: 1, notes: '' }
            : nextText;

        // 先更新 UI，再延遲存檔
        setSchedule(next);
        markDirtyAndAutosave(next);
      };

      /* 新增/刪除員工（新增只給管理員；員工 UI 不顯示） */
      const handleAddStaff = async ()=>{
        const name = (newStaffName || '').trim();
        if(!name){ setStatusMessage('請輸入姓名'); setTimeout(()=>setStatusMessage(''),1000); return; }
        try{
          await callAddStaff(name);
          setNewStaffName('');
          setStatusMessage('新增員工成功！'); setTimeout(()=>setStatusMessage(''),1000);
        }catch(e){
          console.error('addStaff fail', e);
          setStatusMessage(`新增失敗：${e.code||e.message||e}`); setTimeout(()=>setStatusMessage(''),2000);
        }
      };

      const handleDeleteStaff = (name)=>{
        if (!isAdmin) {
          setStatusMessage('只有管理員可以刪除員工'); setTimeout(()=>setStatusMessage(''),1200);
          return;
        }
        setStaffToDel(name); setConfirmOpen(true);
      };

      const confirmDeleteStaff = async (name)=>{
        if (!isAdmin) { setConfirmOpen(false); setStaffToDel(null); return; }
        try{
          await callRemoveStaff(name);
          setStatusMessage('刪除員工成功！'); setTimeout(()=>setStatusMessage(''),1000);
        }catch(e){
          console.error('removeStaff fail', e);
          setStatusMessage(`刪除員工失敗：${e.code||e.message||e}`); setTimeout(()=>setStatusMessage(''),2000);
        }finally{
          setConfirmOpen(false); setStaffToDel(null);
        }
      };

      /* 打卡（每日 + 扁平 mirror） */
      const handlePunchClick = (type) => {
        if (!myName || !myName.trim()) {
          setPendingPunchType(type);
          setNameModalOpen(true);
          return;
        }
        punch(type);
      };
      const punch = async (type)=>{
        if(!db || !user){ setStatusMessage('尚未登入，無法打卡'); setTimeout(()=>setStatusMessage(''),2000); return; }
        const now = new Date();
        const dateKey  = ymdLocal(now);
        const monthKey = ymLocal(now);
        const dailyRef = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance/${dateKey}/logs`);
        const flatRef  = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance_flat_logs`);

        try{
          await addDoc(dailyRef, {
            uid:user.uid, email:user.email||'', displayName:myName||'',
            type, ts: serverTimestamp(), dateKey, by:'web', meta:{ ua:navigator.userAgent||'' }
          });
        }catch(e){
          console.error('punch daily fail', e);
          setStatusMessage(`打卡失敗（daily）：${e.code||e.message}`); setTimeout(()=>setStatusMessage(''),3000);
          return;
        }

        try{
          await addDoc(flatRef, {
            uid:user.uid, email:user.email||'', displayName:myName||'',
            type, ts: serverTimestamp(), clientTime: now.toISOString(),
            dateKey, monthKey, by:'web', meta:{ ua:navigator.userAgent||'' }
          });
        }catch(e){
          console.warn('punch flat mirror fail', e);
        }

        setStatusMessage(type==='IN'?'上班打卡成功！':'下班打卡成功！');
        setTimeout(()=>setStatusMessage(''),1600);

        setTimeout(async ()=>{
          try{
            const snap = await getDocs(dailyRef);
            const list = snap.docs.map(d=>({ id:d.id, ...d.data() }))
                                  .filter(x=>x.uid===user.uid)
                                  .sort((a,b)=> (a.ts?.toMillis?.()||0)-(b.ts?.toMillis?.()||0));
            setMyTodayLogs(list.slice(-2));
            loadTodayLatestIO();
          }catch(e){ console.warn('reload after punch fail', e); }
        }, 600);
      };

      /* 友善列印（A4 橫式單頁 → 建議用這個再另存 PDF） */
      const printScheduleModal = ()=>{
        const y=currentDate.getFullYear(), m0=currentDate.getMonth();
        const html = buildCalendarHTML(y, m0, staffs, schedule, exportMode);
        const win=window.open('','_blank');
        if(!win){ alert('請允許彈出視窗'); return; }
        win.document.write(html);
        win.document.close();
        win.focus();
      };

      /* 出勤彙總（本月） */
      const openAttendanceSummary = async ()=>{
        if(!db || !user) return;
        setAttOpen(true); setAttLoading(true);
        try{
          const monthKey = ymLocal(currentDate);
          const flatRef = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance_flat_logs`);
          const qy = query(flatRef, where('monthKey','==',monthKey), limit(10000));
          const snap = await getDocs(qy);

          const byUid = new Map();
          snap.forEach(docu=>{
            const d=docu.data();
            const rec = byUid.get(d.uid) || { uid:d.uid, name:d.displayName||'', email:d.email||'', days:new Map() };
            const day = rec.days.get(d.dateKey) || { ins:[], outs:[] };
            const ms = d.ts?.toMillis ? d.ts.toMillis() : Date.parse(d.clientTime||0);
            if(d.type==='IN')  day.ins.push(ms);
            if(d.type==='OUT') day.outs.push(ms);
            rec.days.set(d.dateKey, day);
            byUid.set(d.uid, rec);
          });

          const rows=[];
          const getBusinessWindowLocal = (date)=>{
            const dow = date.getDay();
            if(dow===0) return { open:toMin(9,30), close:toMin(21,0) };
            if(dow===6) return { open:toMin(9,0),  close:toMin(21,0) };
            return { open:toMin(9,0),  close:toMin(22,0) };
          };
          for(const rec of byUid.values()){
            let daysPresent=0, missingDays=0, totalMin=0;
            for(const [dateKey,day] of rec.days.entries()){
              const hasIn=day.ins.length>0, hasOut=day.outs.length>0;
              if(hasIn) daysPresent++;
              if(hasIn && !hasOut) missingDays++;
              if(hasIn && hasOut){
                const earliestIn=Math.min(...day.ins);
                const latestOut =Math.max(...day.outs);
                if(latestOut>earliestIn){
                  const [yy,mm,dd]=dateKey.split('-').map(n=>parseInt(n,10));
                  const midnight=new Date(yy,mm-1,dd).setHours(0,0,0,0);
                  const { open, close } = getBusinessWindowLocal(new Date(yy,mm-1,dd));
                  const inMins = Math.max(open, Math.floor((earliestIn - midnight)/60000));
                  const ouMins = Math.min(close, Math.ceil ((latestOut  - midnight)/60000));
                  totalMin += Math.max(0, ouMins - inMins);
                }
              }
            }
            rows.push({
              uid:rec.uid, name:rec.name||'未設定', email:rec.email||'',
              daysPresent, missingDays, totalHours: Math.round((totalMin/60)*2)/2
            });
          }
          rows.sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'));
          setAttRows(rows);
        }catch(e){
          console.error('load monthly summary fail:', e);
          setStatusMessage(`出勤彙總讀取失敗：${e.code||e.message}`); setTimeout(()=>setStatusMessage(''),2000);
          setAttRows([]);
        }finally{ setAttLoading(false); }
      };

      /* 打卡明細（本月） */
      const openMonthlyLogs = async () => {
        if (!db || !user) return;
        setLogOpen(true);
        setLogLoading(true);
        try {
          const monthKey = ymLocal(currentDate);
          const flatRef = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance_flat_logs`);
          const qy = query(flatRef, where('monthKey','==',monthKey), limit(10000));
          const snap = await getDocs(qy);

          const rows = snap.docs.map(d => {
            const x = d.data();
            const ms = x.ts?.toMillis ? x.ts.toMillis() : Date.parse(x.clientTime || 0);
            return {
              id: d.id,
              name: x.displayName || '未設定',
              email: x.email || '',
              type: x.type || '',           // 'IN' | 'OUT'
              ts: x.ts || null,
              ms,
              dateKey: x.dateKey || '',
              by: x.by || 'web'
            };
          }).sort((a,b) => a.ms - b.ms);

          setLogRows(rows);
        } catch (e) {
          console.error('load monthly logs fail:', e);
          setStatusMessage(`打卡明細讀取失敗：${e.code || e.message}`);
          setTimeout(() => setStatusMessage(''), 2000);
          setLogRows([]);
        } finally {
          setLogLoading(false);
        }
      };

      /* 統計（表尾） */
      const stats = useMemo(()=>{
        const result = staffs.reduce((acc,n)=>(acc[n]={totalDays:0,totalHours:0,leaveDays:0}, acc), {});
        const y=currentDate.getFullYear(), m=currentDate.getMonth();
        (schedule||[]).forEach((row,idx)=>{
          if(!Array.isArray(row)) return;
          const date=new Date(y,m,idx+1);
          row.forEach((shift,i)=>{
            const name=staffs[i]; if(!name) return;
            const text=getShiftText(shift);
            if(text==='請假'){ result[name].leaveDays += 1; return; }
            const info=getShiftWindowForDate(date,text);
            if(info.hoursMin>0){ result[name].totalDays+=1; result[name].totalHours += info.hoursMin/60; }
          });
        });
        for(const n in result) result[n].totalHours = Math.round(result[n].totalHours*2)/2;
        return result;
      },[schedule,staffs,currentDate]);

      /* 登入畫面 */
      if(!user){
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
              <div className="flex items-center justify-between">
                <h1 className="text-3xl font-bold text-gray-900">排班系統登入</h1>
                <span className="text-xs text-gray-500">版本 {CODE_VERSION}</span>
              </div>
              {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">電子郵件</label>
                <input type="email" value={email} onChange={e=>{ setEmail(e.target.value); if(rememberEmail) localStorage.setItem('rememberedEmail', e.target.value||''); }}
                       className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                <input type="password" value={password} onChange={e=>setPassword(e.target.value)}
                       className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              </div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="h-4 w-4 text-blue-600 rounded"
                       checked={rememberEmail}
                       onChange={(e)=>{ setRememberEmail(e.target.checked); e.target.checked ? localStorage.setItem('rememberedEmail', email||'') : localStorage.removeItem('rememberedEmail'); }}/>
                記住我的電子郵件
              </label>
              <div className="flex flex-col gap-2">
                <button onClick={async ()=>{
                  setError('');
                  try{ await signInWithEmailAndPassword(auth, email, password); }
                  catch(e){ setError(`${e.code||'auth/error'}: ${e.message}`); }
                }} className="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600">登入</button>
                <button onClick={async ()=>{
                  setError(''); if(password.length<6){ setError('密碼長度至少 6'); return; }
                  try{ await createUserWithEmailAndPassword(auth, email, password); }
                  catch(e){ setError(`${e.code||'auth/error'}: ${e.message}`); }
                }} className="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600">註冊</button>
              </div>
            </div>
          </div>
        );
      }

      /* 主畫面 */
      const daysInMonthVal = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth());

      return (
        <div className="min-h-screen p-4">
          <header className="mb-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold text-gray-900">
                  排班系統 {isAdmin && <span className="ml-2 text-xs px-2 py-1 rounded bg-black text-white align-middle">管理員</span>}
                </h1>
                <p className="text-gray-600 mt-1">
                  目前登入：{user.email || '（未提供）'} ｜ 工作區：<span className="font-semibold">{WORKSPACE_ID}</span>
                </p>
              </div>
              <div className="flex items-center gap-3">
                <span className="text-xs text-gray-500">版本 {CODE_VERSION}</span>
                <button onClick={async ()=>{ try{ await signOut(auth); }catch(e){ setError(`${e.code||'auth/error'}: ${e.message}`); } }}
                        className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">登出</button>
              </div>
            </div>
          </header>

          {statusMessage && (
            <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-2 rounded-full shadow-lg z-50">
              {statusMessage}
            </div>
          )}
          {saving && (
            <div className="fixed top-4 right-4 bg-slate-800 text-white text-sm px-3 py-1.5 rounded shadow z-50">
              儲存中…
            </div>
          )}

          {/* 我的資料（姓名） */}
          <div className="bg-white rounded-xl shadow-lg p-5 mb-6">
            <div className="flex items-end gap-3">
              <div className="flex-1">
                <label className="block text-sm text-gray-600 mb-1">
                  我的姓名（會出現在打卡與報表）
                  {nameLocked && <span className="ml-2 text-xs px-1.5 py-0.5 rounded bg-gray-100 border text-gray-600 align-middle">已鎖定</span>}
                </label>
                <input
                  className={`w-full border rounded px-3 py-2 ${nameLocked ? 'bg-gray-50 text-gray-700 cursor-not-allowed' : ''}`}
                  value={myName}
                  onChange={e=>!nameLocked && setMyName(e.target.value)}
                  placeholder="例如：王小明"
                  disabled={nameLocked}
                />
              </div>
              <button
                onClick={saveMyName}
                className={`px-4 py-2 rounded text-white ${nameLocked ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'} disabled:opacity-60`}
                disabled={nameLocked}
                title={nameLocked ? '姓名已鎖定，無法變更' : '儲存姓名'}
              >
                {nameLocked ? '已鎖定' : '儲存姓名'}
              </button>
            </div>
          </div>

          {/* 打卡 + 今日最新上/下班 */}
          <div className="bg-white rounded-xl shadow-lg p-5 mb-6">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div className="flex gap-2">
                <button onClick={()=>handlePunchClick('IN')}  className="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600">上班打卡</button>
                <button onClick={()=>handlePunchClick('OUT')} className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">下班打卡</button>
              </div>
              <div className="text-sm text-gray-600">
                今天打卡紀錄：{
                  myTodayLogs.length
                    ? myTodayLogs.map(l => `${l.type==='IN'?'上班打卡':'下班打卡'} ${fmtYMDHM(l.ts)}`).join('｜')
                    : '—'
                }
              </div>
            </div>

            <div className="mt-4">
              <div className="flex items-center justify-between gap-3 mb-2">
                <h2 className="text-lg font-semibold">今日所有人的最新上/下班</h2>
                <button onClick={loadTodayLatestIO} className="px-3 py-2 bg-slate-700 text-white rounded hover:bg-slate-800">重新整理</button>
              </div>
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="px-3 py-2 text-left">姓名</th>
                      <th className="px-3 py-2 text-left">帳號</th>
                      <th className="px-3 py-2 text-left">最新上班</th>
                      <th className="px-3 py-2 text-left">最新下班</th>
                    </tr>
                  </thead>
                  <tbody>
                    {todayLatestIO.map(r=>(
                      <tr key={r.uid} className="border-t">
                        <td className="px-3 py-2">{r.displayName || '未設定'}</td>
                        <td className="px-3 py-2">{r.email || r.uid}</td>
                        <td className="px-3 py-2">
                          {r.inTs
                            ? <span className="inline-block px-2 py-1 rounded text-xs font-medium bg-emerald-100 text-emerald-800">上班 {fmtYMDHM(r.inTs)}</span>
                            : <span className="text-gray-400">—</span>}
                        </td>
                        <td className="px-3 py-2">
                          {r.outTs
                            ? <span className="inline-block px-2 py-1 rounded text-xs font-medium bg-amber-100 text-amber-800">下班 {fmtYMDHM(r.outTs)}</span>
                            : <span className="text-gray-400">—</span>}
                        </td>
                      </tr>
                    ))}
                    {!todayLatestIO.length && (
                      <tr><td className="px-3 py-4 text-gray-400" colSpan={4}>（今天尚無資料）</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          {/* 控制列 + 管理員工具列 */}
          <div className="bg-white rounded-xl shadow-lg p-5 mb-6">
            <div className="flex flex-col md:flex-row items-center justify-between gap-3">
              <div className="flex gap-2 w-full md:w-auto">
                <button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))}
                        className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">上一月</button>
                <select
                  value={`${currentDate.getFullYear()}-${pad2(currentDate.getMonth()+1)}`}
                  onChange={(e)=>{ const [yy,mm]=e.target.value.split('-'); setCurrentDate(new Date(+yy, +mm-1, 1)); }}
                  className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-auto"
                >
                  {Array.from({length:25},(_,i)=>i-12).map(off=>{
                    const d=new Date(); d.setMonth(d.getMonth()+off);
                    const v=`${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
                    return <option key={v} value={v}>{d.getFullYear()}年{d.getMonth()+1}月</option>;
                  })}
                </select>
                <button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))}
                        className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">下一月</button>
              </div>

              {/* 管理員可見：新增員工 */}
              {isAdmin && (
                <div className="flex flex-wrap md:flex-nowrap items-stretch md:items-center gap-2 w-full md:w-auto">
                  <input
                    type="text"
                    value={newStaffName}
                    onChange={e => setNewStaffName(e.target.value)}
                    placeholder="新增員工姓名"
                    className="border rounded-lg px-4 py-2 flex-1 min-w-[240px] w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                  <button onClick={handleAddStaff}
                          className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 whitespace-nowrap">
                    新增
                  </button>
                </div>
              )}

              {/* 手動儲存 / 匯出 / 報表 */}
              <div className="flex flex-wrap md:flex-nowrap items-stretch md:items-center gap-2 w-full md:w-auto">
                <button onClick={manualSave}
                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 whitespace-nowrap">手動儲存</button>
                <button onClick={()=>setExportOpen(true)}
                        className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 whitespace-nowrap">匯出班表</button>
                <button onClick={openAttendanceSummary}
                        className="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800 whitespace-nowrap">出勤彙總（本月）</button>
                <button onClick={openMonthlyLogs}
                        className="px-4 py-2 bg-fuchsia-600 text-white rounded-lg hover:bg-fuchsia-700 whitespace-nowrap">打卡明細（本月）</button>
              </div>
            </div>

            {/* 管理員工具列：升/降管理員 */}
            {isAdmin && (
              <div className="mt-4 border-t pt-4">
                <h3 className="font-semibold mb-2">管理員工具列</h3>
                <div className="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                  <input
                    value={adminTarget}
                    onChange={e=>setAdminTarget(e.target.value)}
                    placeholder="輸入姓名 / Email / UID"
                    className="border rounded-lg px-3 py-2 flex-1 min-w-[260px]"
                  />
                  <button
                    onClick={async ()=>{
                      try{
                        setAdminBusy(true);
                        await promoteByInput(db, func, adminTarget);
                        setStatusMessage('已升級為管理員');
                        setTimeout(()=>setStatusMessage(''),1000);
                      }catch(e){
                        setStatusMessage(`升級失敗：${e.message||e}`);
                        setTimeout(()=>setStatusMessage(''),2000);
                      }finally{ setAdminBusy(false); }
                    }}
                    className="px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-60"
                    disabled={adminBusy}
                  >升級為管理員</button>

                  <button
                    onClick={async ()=>{
                      try{
                        setAdminBusy(true);
                        await revokeByInput(db, func, adminTarget);
                        setStatusMessage('已取消管理員');
                        setTimeout(()=>setStatusMessage(''),1000);
                      }catch(e){
                        setStatusMessage(`取消失敗：${e.message||e}`);
                        setTimeout(()=>setStatusMessage(''),2000);
                      }finally{ setAdminBusy(false); }
                    }}
                    className="px-3 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 disabled:opacity-60"
                    disabled={adminBusy}
                  >取消管理員</button>
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  提示：若用「姓名」查到多位同名，系統會要求改用 Email 或 UID。
                </p>
              </div>
            )}

            <div className="mt-4 text-sm text-gray-700 space-y-1">
              <div className="flex flex-wrap gap-4">
                <div>週一～週五：09:00–22:00</div>
                <div>週六：09:00–21:00</div>
                <div>週日：09:30–21:00</div>
              </div>
              <div className="text-xs text-gray-500">
                提示：點格子可循環班別（[早] → [早＋午] → [午] → [午＋晚] → [晚] → [全天] → [休] → [支援樹林] → [請假] → [空白]）
              </div>
            </div>
          </div>

          {/* 主表 */}
          <div className="overflow-x-auto scrollbar-hide">
            <div className="min-w-max bg-white rounded-xl shadow-lg overflow-hidden">
              <table className="w-full text-left">
                <thead className="bg-gray-200 sticky top-0 z-10">
                  <tr>
                    <th className="px-4 py-3 border-r-2 border-gray-300 whitespace-nowrap">日期</th>
                    {staffs.map((name, idx)=>(
                      <th key={idx} className="px-4 py-3 border-r-2 border-gray-300 whitespace-nowrap">
                        <div className="flex justify-between items-center">
                          <span>{name}</span>
                          <button onClick={()=>handleDeleteStaff(name)}
                                  className={`text-red-500 hover:text-red-700 ${!isAdmin ? 'opacity-30 cursor-not-allowed' : ''}`}
                                  title={isAdmin ? "刪除" : "只有管理員可刪除"}
                                  disabled={!isAdmin}
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clipRule="evenodd"/>
                            </svg>
                          </button>
                        </div>
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {Array.from({ length: daysInMonthVal }).map((_, dayIdx) => {
                    const day = dayIdx + 1;
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dowName = getDowName(currentDate.getFullYear(), currentDate.getMonth(), day);

                    return (
                      <tr key={dayIdx} className="border-t">
                        <td className="px-4 py-2 border-r-2 border-gray-300 whitespace-nowrap font-bold text-gray-700">
                          {currentDate.getMonth() + 1}月{day}號（{dowName}）
                        </td>

                        {staffs.map((ownerName, idx) => {
                          const cur = (schedule[dayIdx] && schedule[dayIdx][idx]) || '';
                          const cls =
                            SHIFT_COLOR[(typeof cur === 'object') ? '請假' : getShiftText(cur)] || SHIFT_COLOR[''];
                          const editable = isAdmin || (myName && ownerName === myName);

                          return (
                            <td key={idx} className="px-2 py-2 border-r-2 border-gray-300 text-center w-[120px] min-w-[120px] md:w-auto md:min-w-0">
                              <div
                                onClick={() => editable ? handleShiftChange(dayIdx, idx) : (setStatusMessage('你只能編輯自己的班表'), setTimeout(()=>setStatusMessage(''),900))}
                                className={`p-1.5 md:p-2 rounded-lg ${editable ? 'cursor-pointer hover:shadow-md' : 'opacity-60 cursor-not-allowed'} transition text-xs md:text-sm ${cls}`}
                                title={editable ? '' : '非管理員只能編輯自己'}
                              >
                                {(() => {
                                  const text = getShiftText(cur);
                                  if (!text) return '';
                                  if (text === '請假' && typeof cur === 'object') return '請假';
                                  const info = getShiftWindowForDate(date, text);
                                  return (
                                    <>
                                      <div className="font-bold">{text}</div>
                                      <div className="text-xs">{info.label}</div>
                                    </>
                                  );
                                })()}
                              </div>
                            </td>
                          );
                        })}
                      </tr>
                    );
                  })}
                </tbody>
                <tfoot className="bg-gray-200 sticky bottom-0 z-10">
                  <tr>
                    <td className="px-4 py-3 border-r-2 border-gray-300 font-bold whitespace-nowrap">總計</td>
                    {staffs.map((name, idx)=>(
                      <td key={idx} className="px-4 py-3 border-r-2 border-gray-300 text-sm whitespace-nowrap">
                        <div>
                          <p>總天數: {stats[name]?.totalDays || 0}</p>
                          <p>總時數: {stats[name]?.totalHours || 0} 小時</p>
                          <p>請假天數: {stats[name]?.leaveDays || 0}</p>
                        </div>
                      </td>
                    ))}
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          {/* 刪除確認 */}
          {confirmOpen && (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-[110]">
              <div className="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
                <h3 className="text-lg font-bold mb-4">確認刪除</h3>
                <p className="mb-6">是否確認刪除員工 <span className="font-semibold text-red-600">"{staffToDel}"</span>？此操作無法復原。</p>
                <div className="flex justify-center gap-3">
                  <button onClick={()=>{ setConfirmOpen(false); setStaffToDel(null); }} className="px-4 py-2 bg-gray-200 rounded-lg">取消</button>
                  <button onClick={()=>confirmDeleteStaff(staffToDel)} className="px-4 py-2 bg-red-500 text-white rounded-lg">確認刪除</button>
                </div>
              </div>
            </div>
          )}

          {/* 第一次使用：姓名彈窗 */}
          {nameModalOpen && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                <div className="px-5 py-4 border-b flex items-center justify-between">
                  <h3 className="text-lg font-semibold">第一次使用：請設定姓名</h3>
                  <button onClick={()=>{ setNameModalOpen(false); setPendingPunchType(null); }}
                          className="px-2 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">關閉</button>
                </div>
                <div className="p-5 space-y-3">
                  <label className="block text-sm text-gray-600">我的姓名</label>
                  <input
                    className="w-full border rounded px-3 py-2"
                    placeholder="例如：王小明"
                    value={myName}
                    onChange={e=>setMyName(e.target.value)}
                  />
                  {staffs?.length > 0 && (
                    <div className="text-sm">
                      <span className="text-gray-600 mr-2">或從員工名單選擇：</span>
                      <select className="border rounded px-2 py-1" onChange={e=>setMyName(e.target.value)} value={myName || ''}>
                        <option value="">— 選擇 —</option>
                        {staffs.map(n => <option key={n} value={n}>{n}</option>)}
                      </select>
                    </div>
                  )}
                </div>
                <div className="px-5 py-4 border-t flex items-center justify-end gap-2">
                  <button onClick={()=>{ setNameModalOpen(false); setPendingPunchType(null); }}
                          className="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300">取消</button>
                  <button onClick={saveMyName}
                          className="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    儲存並繼續
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* 匯出班表（行事曆） */}
          {exportOpen && (
            <div className="fixed inset-0 bg-black/50 flex items-start justify-center pt-10 p-4 z-[120]">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[80vh] overflow-hidden flex flex-col">
                <div className="px-5 py-4 border-b flex items-center justify-between sticky top-0 bg-white z-[1]">
                  <h3 className="text-lg font-semibold">
                    {currentDate.getFullYear()}年{pad2(currentDate.getMonth()+1)}月 班表
                  </h3>
                  <div className="flex items-center gap-2">
                    <div className="flex bg-gray-100 rounded-lg p-1 text-sm">
                      <button
                        className={`px-3 py-1.5 rounded ${exportMode==='full' ? 'bg-white shadow font-medium' : 'text-gray-600'}`}
                        onClick={()=>setExportMode('full')}
                        title="顯示姓名、班別與時段"
                      >完整</button>
                      <button
                        className={`px-3 py-1.5 rounded ${exportMode==='simple' ? 'bg-white shadow font-medium' : 'text-gray-600'}`}
                        onClick={()=>setExportMode('simple')}
                        title="僅顯示姓名：班別"
                      >精簡</button>
                    </div>
                    <button onClick={printScheduleModal}
                            className="px-3 py-1.5 text-sm bg-slate-700 text-white rounded hover:bg-slate-800">友善列印</button>
                    <button onClick={()=>setExportOpen(false)}
                            className="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300">關閉</button>
                  </div>
                </div>

                <div className="p-5 overflow-auto" ref={exportRef}>
                  <div className="w-[1120px] sm:w-auto mx-auto">
                    <div className="grid grid-cols-7 gap-2 text-center text-[11px] sm:text-sm text-gray-600">
                      {['一','二','三','四','五','六','日'].map(w => (
                        <div key={w} className="font-semibold">{w}</div>
                      ))}
                    </div>

                    <div className="grid grid-cols-7 gap-2 mt-2">
                      {(() => {
                        const y = currentDate.getFullYear(), m = currentDate.getMonth();
                        const first = new Date(y, m, 1);
                        const total = getDaysInMonth(y, m);
                        const firstDowMonStart = (first.getDay() + 6) % 7;
                        const cells = Array.from({length:firstDowMonStart}, ()=>null)
                                           .concat(Array.from({length: total}, (_,i)=> i+1));
                        while (cells.length % 7 !== 0) cells.push(null);

                        return cells.map((d, idx) => (
                          <div key={idx} className="min-h-[5rem] sm:min-h-[7rem] border rounded p-1.5 sm:p-2 bg-white">
                            {d ? (
                              <>
                                <div className="flex items-center justify-between text-[10px] sm:text-xs text-gray-500">
                                  <span className="inline-block px-1 py-0.5 rounded bg-gray-100 border">{m+1}/{d}</span>
                                  <span></span>
                                </div>

                                <div className="mt-1 space-y-1 text-[11px] sm:text-sm leading-tight">
                                  {(() => {
                                    const items = staffs.map((name, si) => {
                                      const v = schedule[d-1]?.[si] ?? '';
                                      const t = getShiftText(v);
                                      if (!t || t==='休' || t==='請假') return null;

                                      const tDisp = t.replace('早+午','早＋午').replace('午+晚','午＋晚');

                                      if (exportMode === 'full') {
                                        const info  = getShiftWindowForDate(new Date(y, m, d), t);
                                        const short = info.label ? (info.label.split(' (')[0] || '') : '';
                                        return (
                                          <div key={name+si} className="leading-tight">
                                            <div className="truncate">
                                              <span className="font-medium">{name}</span> {tDisp}
                                            </div>
                                            {short && <div className="text-[10px] sm:text-xs text-gray-600">{short}</div>}
                                          </div>
                                        );
                                      } else {
                                        return (
                                          <div key={name+si} className="truncate">
                                            <span className="font-medium">{name}</span>：{tDisp}
                                          </div>
                                        );
                                      }
                                    }).filter(Boolean);
                                    return items.length ? items : <div className="text-gray-300">—</div>;
                                  })()}
                                </div>
                              </>
                            ) : null}
                          </div>
                        ));
                      })()}
                    </div>

                    <div className="mt-2 text-center text-xs text-gray-500 sm:hidden">
                      （手機可左右滑動檢視）
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* 打卡明細（本月） */}
          {logOpen && (
            <div className="fixed inset-0 bg-black/50 flex items-start justify-center pt-10 p-4 z-[124]">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[80vh] overflow-hidden flex flex-col">
                <div className="px-5 py-4 border-b flex items-center justify-between sticky top-0 bg-white z-[1]">
                  <h3 className="text-lg font-semibold">
                    {currentDate.getFullYear()}年{pad2(currentDate.getMonth()+1)}月 打卡明細
                  </h3>
                  <div className="flex items-center gap-2">
                    <select value={logFilterName} onChange={e=>setLogFilterName(e.target.value)}
                            className="border rounded px-2 py-1 text-sm">
                      <option value="">全部人員</option>
                      {staffs.map(n => <option key={n} value={n}>{n}</option>)}
                    </select>
                    <select value={logFilterType} onChange={e=>setLogFilterType(e.target.value)}
                            className="border rounded px-2 py-1 text-sm">
                      <option value="ALL">全部類型</option>
                      <option value="IN">上班</option>
                      <option value="OUT">下班</option>
                    </select>

                    <button
                      onClick={()=>{
                        const zhType = t => t==='IN' ? '上班' : (t==='OUT' ? '下班' : t);
                        const rows = [['日期','姓名','帳號','類型','時間','來源']];
                        const filtered = logRows.filter(r =>
                          (logFilterName ? r.name===logFilterName : true) &&
                          (logFilterType==='ALL' ? true : r.type===logFilterType)
                        );
                        filtered.forEach(r=>{
                          rows.push([
                            r.dateKey,
                            r.name,
                            r.email || r.id,
                            zhType(r.type),
                            fmtYMDHM(r.ts || new Date(r.ms)),
                            r.by || ''
                          ]);
                        });
                        const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
                        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href=url;
                        const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
                        a.download=`打卡明細_${y}-${pad2(m)}.csv`; a.click();
                        URL.revokeObjectURL(url);
                      }}
                      className="px-3 py-1.5 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700"
                      disabled={logLoading}
                    >下載CSV</button>

                    <button
                      onClick={()=>{
                        const y=currentDate.getFullYear(), mo=currentDate.getMonth()+1;
                        const win=window.open('','_blank'); if(!win){ alert('請允許彈出視窗'); return; }
                        win.document.write(
                          '<html><head><meta charset="utf-8"/><title>'+y+'年'+pad2(mo)+'月 打卡明細</title>'+
                          '<style>@page { size: A4 landscape; margin: 10mm; }'+
                          'body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Noto Sans TC",sans-serif;padding:16px}'+
                          'table{border-collapse:collapse;width:100%} th,td{border:1px solid #e5e7eb;padding:8px;text-align:left} thead{background:#f3f4f6}'+
                          '</style></head><body>'+
                          '<h1 style="margin:0 0 12px;font-size:18px;">'+y+'年'+pad2(mo)+'月 打卡明細</h1>'+
                          '<div id="content">'+(logRef.current ? logRef.current.innerHTML : '')+'</div>'+
                          '</body></html>'
                        );
                        win.document.close(); win.focus();
                      }}
                      className="px-3 py-1.5 text-sm bg-slate-700 text-white rounded hover:bg-slate-800"
                      disabled={logLoading}
                    >友善列印</button>

                    <button onClick={()=>setLogOpen(false)}
                            className="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300">
                      關閉
                    </button>
                  </div>
                </div>

                <div className="p-5 overflow-auto" ref={logRef}>
                  {logLoading ? (
                    <div className="text-gray-500">載入中…</div>
                  ) : (
                    <table className="min-w-full text-sm">
                      <thead>
                        <tr className="bg-gray-100">
                          <th className="px-3 py-2 text-left">日期</th>
                          <th className="px-3 py-2 text-left">姓名</th>
                          <th className="px-3 py-2 text-left">帳號</th>
                          <th className="px-3 py-2 text-left">類型</th>
                          <th className="px-3 py-2 text-left">時間</th>
                          <th className="px-3 py-2 text-left">來源</th>
                        </tr>
                      </thead>
                      <tbody>
                        {logRows
                          .filter(r =>
                            (logFilterName ? r.name===logFilterName : true) &&
                            (logFilterType==='ALL' ? true : r.type===logFilterType)
                          )
                          .map(r=>(
                          <tr key={r.id} className="border-t">
                            <td className="px-3 py-2">{r.dateKey || '—'}</td>
                            <td className="px-3 py-2">{r.name}</td>
                            <td className="px-3 py-2">{r.email || r.id}</td>
                            <td className="px-3 py-2">{r.type==='IN'?'上班':'下班'}</td>
                            <td className="px-3 py-2">{fmtYMDHM(r.ts || new Date(r.ms))}</td>
                            <td className="px-3 py-2">{r.by || ''}</td>
                          </tr>
                        ))}
                        {!logRows.length && (
                          <tr><td className="px-3 py-4 text-gray-400" colSpan={6}>（本月尚無打卡資料）</td></tr>
                        )}
                      </tbody>
                    </table>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* 出勤彙總（本月） */}
          {attOpen && (
            <div className="fixed inset-0 bg-black/50 flex items-start justify-center pt-10 p-4 z-[125]">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[80vh] overflow-hidden flex flex-col">
                <div className="px-5 py-4 border-b flex items-center justify-between sticky top-0 bg-white z-[1]">
                  <h3 className="text-lg font-semibold">
                    {currentDate.getFullYear()}年{pad2(currentDate.getMonth()+1)}月 出勤彙總
                  </h3>
                  <div className="flex items-center gap-2">
                    <button onClick={()=>{
                      const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
                      const rows=[['姓名','帳號','出勤天數','缺卡天數','總時數']];
                      attRows.forEach(r=> rows.push([r.name, r.email || r.uid, r.daysPresent, r.missingDays, r.totalHours]));
                      const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
                      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
                      const url=URL.createObjectURL(blob);
                      const a=document.createElement('a'); a.href=url; a.download=`出勤彙總_${y}-${pad2(m)}.csv`; a.click();
                      URL.revokeObjectURL(url);
                    }}
                            className="px-3 py-1.5 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700" disabled={attLoading}>下載CSV</button>
                    <button onClick={()=>{
                      const y=currentDate.getFullYear(), mo=currentDate.getMonth()+1;
                      const win=window.open('','_blank'); if(!win){ alert('請允許彈出視窗'); return; }
                      win.document.write(
                        '<html><head><meta charset="utf-8"/><title>'+y+'年'+pad2(mo)+'月 出勤彙總</title>' +
                        '<style>@page { size: A4 landscape; margin: 10mm; } body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Noto Sans TC",sans-serif;padding:16px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #e5e7eb;padding:8px;text-align:left} thead{background:#f3f4f6}</style></head>' +
                        '<body><h1 style="margin:0 0 12px;font-size:20px;">'+y+'年'+pad2(mo)+'月 出勤彙總</h1><div id="content">'+ (attRef.current?attRef.current.innerHTML:'') +'</div></body></html>'
                      );
                      win.document.close(); win.focus();
                    }}
                            className="px-3 py-1.5 text-sm bg-slate-700 text-white rounded hover:bg-slate-800" disabled={attLoading}>友善列印</button>
                    <button onClick={()=>setAttOpen(false)}
                            className="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300">關閉</button>
                  </div>
                </div>
                <div className="p-5 overflow-auto" ref={attRef}>
                  {attLoading ? (
                    <div className="text-gray-500">載入中…</div>
                  ) : (
                    <table className="min-w-full text-sm">
                      <thead>
                        <tr className="bg-gray-100">
                          <th className="px-3 py-2 text-left">姓名</th>
                          <th className="px-3 py-2 text-left">帳號</th>
                          <th className="px-3 py-2 text-right">出勤天數</th>
                          <th className="px-3 py-2 text-right">缺卡天數</th>
                          <th className="px-3 py-2 text-right">總時數</th>
                        </tr>
                      </thead>
                      <tbody>
                        {attRows.length ? attRows.map(r=>(
                          <tr key={r.uid} className="border-t">
                            <td className="px-3 py-2">{r.name}</td>
                            <td className="px-3 py-2">{r.email || r.uid}</td>
                            <td className="px-3 py-2 text-right">{r.daysPresent}</td>
                            <td className="px-3 py-2 text-right">{r.missingDays}</td>
                            <td className="px-3 py-2 text-right">{r.totalHours}</td>
                          </tr>
                        )) : (
                          <tr><td className="px-3 py-4 text-gray-400" colSpan={5}>（本月尚無資料或尚未開啟打卡扁平化）</td></tr>
                        )}
                      </tbody>
                    </table>
                  )}
                </div>
              </div>
            </div>
          )}

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
