<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>排班系統（月份行事曆）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase（不載 analytics） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, onSnapshot,
      collection, addDoc, serverTimestamp,
      query, orderBy, limit, getDocs, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // 暴露到全域，讓 Babel 腳本能使用
    window.firebase = {
      initializeApp, getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      getFirestore, doc, setDoc, onSnapshot,
      collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs, getDoc
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
    body { font-family:'Noto Sans TC',sans-serif; }
    .scrollbar-hide::-webkit-scrollbar { display:none; }
    .scrollbar-hide { -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const {
      initializeApp, getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      getFirestore, doc, setDoc, onSnapshot,
      collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs, getDoc
    } = window.firebase;

    // ===== 版本與常數 =====
    const CODE_VERSION = 'v2025.09.22-cal-2';
    const APP_ID = 'zhenan-scheduler';
    const WORKSPACE_ID = 'main';

    // 你的 Firebase 設定（無 analytics）
    const firebaseConfig = {
      apiKey: "AIzaSyA0RjZ0RXst__qzv4e281LUOh2zdiMgmd0",
      authDomain: "zhenan-scheduler.firebaseapp.com",
      projectId: "zhenan-scheduler",
      storageBucket: "zhenan-scheduler.firebasestorage.app",
      messagingSenderId: "217165082111",
      appId: "1:217165082111:web:549c98dd09589029918bca"
    };

    const SHIFT_OPTIONS = ['早班','早+午班','午班','午+晚班','晚班','休','支援樹林','請假'];
    const SHIFT_COLOR = {
      '早班':'bg-blue-200 text-blue-800',
      '早+午班':'bg-indigo-200 text-indigo-800',
      '午班':'bg-teal-200 text-teal-800',
      '午+晚班':'bg-purple-200 text-purple-800',
      '晚班':'bg-red-200 text-red-800',
      '休':'bg-gray-300 text-gray-800',
      '請假':'bg-rose-200 text-rose-800',
      '支援樹林':'bg-lime-200 text-lime-800',
      '': 'bg-white text-gray-500'
    };

    // ===== 小工具 =====
    const toMin = (h, m=0) => h*60 + m;
    const fmtHM = (min) => `${String(Math.floor(min/60)).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
    const fmtHours = (mins) => {
      const h = mins/60;
      return (Math.abs(h - Math.round(h)) < 1e-9) ? `${Math.round(h)}小時` : `${(Math.round(h*2)/2).toFixed(1)}小時`;
    };
    const fmtTime = (ts) => ts?.toDate ? ts.toDate().toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' }) : '—';
    const pad2 = (n)=> String(n).padStart(2,'0');
    const ymdLocal = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const debounce = (fn, delay=500)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay);} };
    const getDaysInMonth = (y,m)=> new Date(y, m+1, 0).getDate();

    // 營業時間（週一~五 09-22、週六 09-21、週日 09:30-21）
    const getBusinessWindow = (date) => {
      const dow = date.getDay(); // 0=日
      if (dow === 0) return { open: toMin(9,30), close: toMin(21,0) }; // 週日
      if (dow === 6) return { open: toMin(9,0),  close: toMin(21,0) }; // 週六
      return { open: toMin(9,0),  close: toMin(22,0) };                // 週一~週五
    };

    const getShiftWindowForDate = (date, shiftText) => {
      const { open, close } = getBusinessWindow(date);
      const cap = (s,e) => {
        const start = Math.max(open, Math.min(s, close));
        const end   = Math.max(start, Math.min(e, close));
        return { start, end };
      };
      if (!shiftText || shiftText==='休' || shiftText==='請假') return { label:'0 小時', hoursMin:0 };
      if (shiftText === '支援樹林') return { label:'', hoursMin:0 };
      let target;
      switch (shiftText) {
        case '早班':    target={start:open,        end:open+toMin(4)}; break;
        case '早+午班': target={start:open,        end:toMin(17,0)};   break;
        case '午班':    target={start:toMin(13,0), end:toMin(17,0)};   break;
        case '午+晚班': target={start:toMin(13,0), end:close};         break;
        case '晚班':    target={start:toMin(16,0), end:close};         break;
        default:        target={start:open,        end:open};
      }
      const { start, end } = cap(target.start, target.end);
      const minutes = Math.max(0, end - start);
      const label = minutes>0 ? `${fmtHM(start)} - ${fmtHM(end)} (${fmtHours(minutes)})` : '0 小時';
      return { label, hoursMin: minutes };
    };

    const getShiftText = (v) => (typeof v === 'object' && v) ? '請假' : (v || '');

    // ===== App =====
    function App(){
      const [db,setDb] = useState(null);
      const [auth,setAuth] = useState(null);
      const [user,setUser] = useState(null);

      const [currentDate,setCurrentDate] = useState(new Date());
      const [staffs,setStaffs] = useState([]);
      const [schedule,setSchedule] = useState([]);
      const [newStaffName,setNewStaffName] = useState('');
      const [statusMessage,setStatusMessage] = useState('');
      const [error,setError] = useState('');
      const [email,setEmail] = useState(localStorage.getItem('rememberedEmail')||'');
      const [password,setPassword] = useState('');
      const [rememberEmail,setRememberEmail] = useState(!!localStorage.getItem('rememberedEmail'));

      const [confirmOpen,setConfirmOpen] = useState(false);
      const [staffToDel,setStaffToDel] = useState(null);

      // 打卡/姓名/今日列表
      const [myTodayLogs,setMyTodayLogs] = useState([]);
      const [myName, setMyName] = useState('');
      const [savingName, setSavingName] = useState(false);
      const [todayLatestIO, setTodayLatestIO] = useState([]);

      // 初始化 Firebase
      useEffect(()=>{
        try{
          const app = initializeApp(firebaseConfig);
          const _db = getFirestore(app);
          const _auth = getAuth(app);
          setDb(_db); setAuth(_auth);
          const unsub = onAuthStateChanged(_auth, cur=> setUser(cur||null));
          return ()=>unsub && unsub();
        }catch(e){ console.error('Firebase 初始化錯誤：', e); }
      },[]);

      // 即時同步（共用工作區）
      useEffect(()=>{
        if(!db || !user) return;
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth()+1;
        const monthId = `${y}-${String(m).padStart(2,'0')}`;
        const staffRef = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/staffs/staffList`);
        const schedRef = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/schedules/${monthId}`);

        const unsubStaff = onSnapshot(staffRef, s=> setStaffs(s.exists() ? (s.data().names||[]) : []));
        const unsubSched = onSnapshot(schedRef, s=>{
          if(s.exists() && s.data().schedule){
            try{ setSchedule(JSON.parse(s.data().schedule)); }
            catch(e){ console.error('班表解析失敗', e); setSchedule([]); }
          }else setSchedule([]);
        });

        return ()=>{ unsubStaff(); unsubSched(); };
      },[db,user,currentDate]);

      // 讀我的姓名（若無則建立空檔）
      useEffect(() => {
        (async () => {
          if (!db || !user) return;
          try {
            const ref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/members/${user.uid}`);
            const snap = await getDoc(ref);
            if (snap.exists()) {
              const d = snap.data();
              setMyName(d.displayName || '');
            } else {
              await setDoc(ref, { email: user.email || '', displayName: '', updatedAt: new Date() }, { merge: true });
            }
          } catch (e) {
            console.warn('讀取我的姓名失敗：', e);
          }
        })();
      }, [db, user]);

      // 今日我的打卡
      useEffect(()=>{
        (async ()=>{
          if (!db || !user) { setMyTodayLogs([]); return; }
          const todayKey = ymdLocal(new Date());
          try{
            const logsRef = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance/${todayKey}/logs`);
            const qy = query(logsRef, orderBy('ts','desc'), limit(10));
            const snap = await getDocs(qy);
            const list = snap.docs.map(d => ({ id:d.id, ...d.data() }))
                                  .filter(x => x.uid === user.uid)
                                  .slice(0, 2);
            setMyTodayLogs(list);
          }catch(e){ console.warn('讀取打卡失敗：', e); setMyTodayLogs([]); }
        })();
      },[db,user]);

      // 今日所有人的最新上/下班
      const loadTodayLatestIO = async () => {
        if (!db || !user) return;
        const dateKey = ymdLocal(new Date());
        try {
          const logsRef = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance/${dateKey}/logs`);
          const qy = query(logsRef, orderBy('ts','desc'), limit(2000));
          const snap = await getDocs(qy);
          const map = new Map();
          for (const docu of snap.docs) {
            const d = docu.data();
            const entry = map.get(d.uid) || { uid: d.uid, displayName: d.displayName || '', email: d.email || '', inTs: null, outTs: null };
            if (d.type === 'IN'  && !entry.inTs)  entry.inTs  = d.ts || null;
            if (d.type === 'OUT' && !entry.outTs) entry.outTs = d.ts || null;
            map.set(d.uid, entry);
          }
          setTodayLatestIO(Array.from(map.values()));
        } catch (e) {
          console.error('載入今日最新上/下班失敗：', e);
          setStatusMessage(`載入失敗：${e.code || e.message}`); setTimeout(()=>setStatusMessage(''), 2000);
        }
      };
      useEffect(() => { if (db && user) loadTodayLatestIO(); }, [db, user]);

      // 儲存姓名
      async function saveMyName() {
        if (!db || !user) return;
        setSavingName(true);
        try {
          const ref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/members/${user.uid}`);
          await setDoc(ref, { displayName: myName || '', email: user.email || '', updatedAt: new Date() }, { merge: true });
          setStatusMessage('姓名已儲存');
          setTimeout(() => setStatusMessage(''), 1200);
        } catch (e) {
          console.error('儲存姓名失敗：', e);
          setStatusMessage(`儲存姓名失敗：${e.code || e.message}`);
          setTimeout(() => setStatusMessage(''), 2000);
        } finally {
          setSavingName(false);
        }
      }

      // 排班資料處理
      const sanitizeSchedule = (data) =>
        Array.isArray(data)
          ? data.map(row => Array.isArray(row) ? row.map(v => (v === undefined ? '' : v)) : [])
          : [];

      const saveSchedule = debounce(async (scheduleData) => {
        if (!db || !user) return;
        try {
          const y = currentDate.getFullYear();
          const m = currentDate.getMonth() + 1;
          const monthId = `${y}-${String(m).padStart(2,'0')}`;
          const sref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/schedules/${monthId}`);
          await setDoc(
            sref,
            { schedule: JSON.stringify(sanitizeSchedule(scheduleData)), lastUpdated: new Date() },
            { merge: true }
          );
          setStatusMessage('班表已儲存！');
          setTimeout(() => setStatusMessage(''), 1200);
        } catch (e) {
          console.error('儲存班表失敗：', e);
          setStatusMessage(`儲存失敗：${e.code || e.message}`);
          setTimeout(() => setStatusMessage(''), 2000);
        }
      }, 500);

      const manualSave = () => saveSchedule(schedule);

      // 點擊切換班別（在日格內、針對某位員工）
      const cycleShift = (dayIndex, staffIndex) => {
        const next = [...(schedule || [])];
        const cols = staffs.length;
        next[dayIndex] = next[dayIndex] ? [...next[dayIndex]] : Array(cols).fill('');
        const cur = next[dayIndex][staffIndex] || '';
        const curText = (typeof cur === 'object') ? '請假' : cur;
        const idx = SHIFT_OPTIONS.indexOf(curText);
        const nextIdx = (idx + 1) % SHIFT_OPTIONS.length;
        const nextShift = SHIFT_OPTIONS[nextIdx];
        next[dayIndex][staffIndex] =
          (nextShift === '請假')
            ? { shift: '請假', type: '未備註', days: 1, notes: '' }
            : nextShift;
        setSchedule(next);
        saveSchedule(next);
      };

      // 新增/刪除員工
      const handleAddStaff = async () => {
        const name = (newStaffName || '').trim();
        if (!name) return;
        if (staffs.includes(name)) {
          setStatusMessage('該員工已存在！');
          setTimeout(() => setStatusMessage(''), 1200);
          return;
        }
        const nextStaffs = [...staffs, name];
        setStaffs(nextStaffs);

        const next = (schedule || []).map(row =>
          Array.isArray(row) ? [...row, ''] : Array(nextStaffs.length).fill('')
        );
        setSchedule(next);
        setNewStaffName('');

        try {
          if (db && user) {
            const ref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/staffs/staffList`);
            await setDoc(ref, { names: nextStaffs }, { merge: true });
            setStatusMessage('新增員工成功！');
            setTimeout(() => setStatusMessage(''), 1200);
          }
        } catch (e) {
          console.error('新增員工失敗：', e);
          setStatusMessage(`新增失敗：${e.code || e.message}`);
          setTimeout(() => setStatusMessage(''), 2000);
        }
      };

      const confirmDeleteStaff = async (name) => {
        const idx = staffs.findIndex(n => n === name);
        if (idx === -1) return;
        const nextStaffs = staffs.filter((_, i)=> i !== idx);
        const nextSched  = (schedule||[]).map(day=> Array.isArray(day) ? day.filter((_,i)=> i!==idx) : []);
        setStaffs(nextStaffs);
        setSchedule(nextSched);
        try{
          if(db && user){
            const ref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/staffs/staffList`);
            await setDoc(ref, { names: nextStaffs }, { merge:true });
            const y=currentDate.getFullYear(), mo=currentDate.getMonth()+1, monthId=`${y}-${String(mo).padStart(2,'0')}`;
            const sref = doc(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/schedules/${monthId}`);
            await setDoc(sref, { schedule: JSON.stringify(nextSched), lastUpdated: new Date() }, { merge:true });
          }
          setStatusMessage('刪除員工成功！'); setTimeout(()=>setStatusMessage(''),1200);
        }catch(e){
          console.error(e); setStatusMessage(`刪除員工失敗：${e.code||e.message}`); setTimeout(()=>setStatusMessage(''),2000);
        } finally {
          setConfirmOpen(false);
          setStaffToDel(null);
        }
      };

      const handleDeleteStaff = (name) => { setStaffToDel(name); setConfirmOpen(true); };

      // 打卡
      const punch = async (type) => {
        if (!db || !user) return;
        const dateKey = ymdLocal(new Date());
        const logsRef = collection(db, `artifacts/${APP_ID}/workspaces/${WORKSPACE_ID}/attendance/${dateKey}/logs`);
        try {
          await addDoc(logsRef, {
            uid: user.uid, email: user.email || '', displayName: myName || '',
            type, ts: serverTimestamp(), by: 'web', meta: { ua: navigator.userAgent || '' }
          });
          setStatusMessage(type === 'IN' ? '上班打卡成功！' : '下班打卡成功！');
          setTimeout(() => setStatusMessage(''), 1600);
        } catch (e) {
          console.error('打卡寫入失敗：', e);
          setStatusMessage(`打卡失敗：${e.code || e.message}`);
          setTimeout(() => setStatusMessage(''), 2000);
          return;
        }
        try {
          const qy = query(logsRef, orderBy('ts','desc'), limit(10));
          const snap = await getDocs(qy);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                                .filter(x => x.uid === user.uid)
                                .slice(0, 2);
          setMyTodayLogs(list);
          loadTodayLatestIO();
        } catch (e) {
          console.warn('打卡寫入成功，但列表查詢失敗', e);
        }
      };

      // 匯出（開新視窗，週一→週日，格內顯示「月/日」與上班名單）
      const openExportWindow = () => {
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        const first = new Date(y, m, 1);
        const days = getDaysInMonth(y, m);
        const firstDowMonStart = (first.getDay() + 6) % 7;

        const cells = Array.from({ length: firstDowMonStart }, () => null)
          .concat(Array.from({ length: days }, (_, i) => i + 1));
        while (cells.length % 7 !== 0) cells.push(null);

        const buildCell = (d) => {
          if (!d) return '<div class="min-h-[8rem] border rounded p-2 bg-white"></div>';
          const md = `${m+1}/${d}`;
          const items = staffs.map((name, i) => {
            const v = schedule[d - 1]?.[i] ?? '';
            const t = getShiftText(v);
            if (!t || t === '休' || t === '請假') return '';
            return `<div class="truncate"><span class="font-medium">${name}</span>：${t}</div>`;
          }).filter(Boolean).join('') || '<div class="text-gray-300">—</div>';

          return `
            <div class="min-h-[8rem] border rounded p-2 bg-white">
              <div class="flex items-center justify-between text-xs text-gray-500">
                <span class="inline-block px-1.5 py-0.5 rounded bg-gray-100 border">${md}</span>
                <span></span>
              </div>
              <div class="mt-1 space-y-1 text-sm">${items}</div>
            </div>`;
        };

        const win = window.open('', '_blank');
        if (!win) { alert('請允許彈出視窗'); return; }
        win.document.write('<html><head><meta charset="utf-8"/><title>班表</title></head><body></body></html>');
        const s = win.document.createElement('script');
        s.src = 'https://cdn.tailwindcss.com';
        win.document.head.appendChild(s);

        const container = win.document.createElement('div');
        const weekHeader = ['一','二','三','四','五','六','日']
          .map(w => `<div class="font-semibold text-center text-sm text-gray-600">${w}</div>`).join('');
        container.innerHTML = `
          <div class="p-6 bg-gray-50 min-h-screen">
            <div class="flex items-center justify-between mb-4">
              <h1 class="text-2xl font-bold">${y}年${String(m + 1).padStart(2,'0')}月 班表（週一→週日）</h1>
              <div class="flex gap-2">
                <button id="btn-csv" class="px-3 py-1.5 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700">下載CSV</button>
                <button id="btn-print" class="px-3 py-1.5 text-sm bg-slate-700 text-white rounded hover:bg-slate-800">列印 / 存PDF</button>
                <button id="btn-close" class="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300">關閉</button>
              </div>
            </div>
            <div class="grid grid-cols-7 gap-2">${weekHeader}</div>
            <div class="grid grid-cols-7 gap-2 mt-2">${cells.map(buildCell).join('')}</div>
          </div>
        `;
        win.document.body.appendChild(container);

        setTimeout(() => {
          const btnCSV = win.document.getElementById('btn-csv');
          const btnPrint = win.document.getElementById('btn-print');
          const btnClose = win.document.getElementById('btn-close');

          btnCSV?.addEventListener('click', () => {
            const rows = [['日期','姓名','班別']];
            for (let d = 1; d <= days; d++) {
              staffs.forEach((name, i) => {
                const v = schedule[d - 1]?.[i] ?? '';
                const t = getShiftText(v);
                if (!t || t === '休' || t === '請假') return;
                rows.push([`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`, name, t]);
              });
            }
            const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = win.URL.createObjectURL(blob);
            const a = win.document.createElement('a');
            a.href = url;
            a.download = `班表_${y}-${String(m+1).padStart(2,'0')}.csv`;
            a.click();
            setTimeout(() => win.URL.revokeObjectURL(url), 1000);
          });

          btnPrint?.addEventListener('click', () => win.print());
          btnClose?.addEventListener('click', () => win.close());
        }, 0);
      };

      // 登入/註冊/登出
      const doRegister = async ()=>{
        setError('');
        if(password.length<6){ setError('密碼長度必須至少為6個字元'); return; }
        try{
          await createUserWithEmailAndPassword(auth, email, password);
          if (rememberEmail) localStorage.setItem('rememberedEmail', email); else localStorage.removeItem('rememberedEmail');
          setStatusMessage('註冊成功！'); setTimeout(()=>setStatusMessage(''),1600);
        }catch(e){ setError(`${e.code||'auth/error'}: ${e.message}`); }
      };
      const doLogin = async ()=>{
        setError('');
        try{
          await signInWithEmailAndPassword(auth, email, password);
          if (rememberEmail) localStorage.setItem('rememberedEmail', email); else localStorage.removeItem('rememberedEmail');
          setStatusMessage('登入成功！'); setTimeout(()=>setStatusMessage(''),1600);
        }catch(e){ setError(`${e.code||'auth/error'}: ${e.message}`); }
      };
      const doLogout = async ()=>{
        setError('');
        try{ await signOut(auth); setStatusMessage('登出成功！'); setTimeout(()=>setStatusMessage(''),1600); }
        catch(e){ setError(`${e.code||'auth/error'}: ${e.message}`); }
      };

      // 統計（依日期裁切後時段）
      const stats = useMemo(()=>{
        const result = staffs.reduce((acc,n)=>(acc[n]={totalDays:0,totalHours:0,leaveDays:0}, acc), {});
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        (schedule||[]).forEach((dayRow, dIdx)=>{
          if(!Array.isArray(dayRow)) return;
          const date = new Date(y, m, dIdx+1);
          dayRow.forEach((shift, i)=>{
            const name = staffs[i]; if(!name) return;
            const text = getShiftText(shift);
            if (text==='請假'){ result[name].leaveDays += 1; return; }
            const { hoursMin } = getShiftWindowForDate(date, text);
            if (hoursMin>0){ result[name].totalDays += 1; result[name].totalHours += hoursMin/60; }
          });
        });
        for(const n in result){ result[n].totalHours = Math.round(result[n].totalHours*2)/2; }
        return result;
      }, [schedule, staffs, currentDate]);

      // 未登入畫面
      if(!user){
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div className="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
              <div className="flex items-center justify-between">
                <h1 className="text-3xl font-bold text-gray-900">排班系統登入</h1>
                <span className="text-xs text-gray-500">版本 {CODE_VERSION}</span>
              </div>
              {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">電子郵件</label>
                <input type="email" value={email} onChange={e=>setEmail(e.target.value)}
                       className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                <input type="password" value={password} onChange={e=>setPassword(e.target.value)}
                       className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              </div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="h-4 w-4 text-blue-600 rounded"
                       checked={rememberEmail} onChange={e=>setRememberEmail(e.target.checked)}/>
                記住我的電子郵件
              </label>
              <div className="flex flex-col gap-2">
                <button onClick={doLogin} className="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600">登入</button>
                <button onClick={doRegister} className="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600">註冊</button>
              </div>
            </div>
          </div>
        );
      }

      // 已登入畫面（月份行事曆）
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      const totalDays = getDaysInMonth(y, m);
      const first = new Date(y, m, 1);
      const firstDowMonStart = (first.getDay() + 6) % 7;
      const calendarCells = Array.from({ length: firstDowMonStart }, () => null)
        .concat(Array.from({ length: totalDays }, (_, i) => i + 1));
      while (calendarCells.length % 7 !== 0) calendarCells.push(null);

      return (
        <div className="min-h-screen p-4">
          <header className="mb-5">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold text-gray-900">排班系統（月份行事曆）</h1>
                <p className="text-gray-600 mt-1">
                  目前登入：{user.email || '（未提供）'}　｜　工作區：<span className="font-semibold">{WORKSPACE_ID}</span>
                </p>
              </div>
              <div className="flex items-center gap-3">
                <span className="text-xs text-gray-500">版本 {CODE_VERSION}</span>
                <button onClick={doLogout} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">登出</button>
              </div>
            </div>
          </header>

          {statusMessage && (
            <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-2 rounded-full shadow-lg z-50">
              {statusMessage}
            </div>
          )}

          {/* 我的資料（姓名） */}
          <div className="bg-white rounded-xl shadow-lg p-5 mb-5">
            <div className="flex items-end gap-3">
              <div className="flex-1">
                <label className="block text-sm text-gray-600 mb-1">我的姓名（會出現在打卡與報表）</label>
                <input className="w-full border rounded px-3 py-2"
                       value={myName} onChange={e=>setMyName(e.target.value)} placeholder="例如：王小明"/>
              </div>
              <button onClick={saveMyName}
                      className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-60"
                      disabled={savingName}>
                {savingName ? '儲存中…' : '儲存姓名'}
              </button>
            </div>
          </div>

          {/* 打卡 + 今日最新上/下班 */}
          <div className="bg-white rounded-xl shadow-lg p-5 mb-5">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div className="flex gap-2">
                <button onClick={()=>punch('IN')}  className="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600">上班打卡</button>
                <button onClick={()=>punch('OUT')} className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">下班打卡</button>
              </div>
              <div className="text-sm text-gray-600">
                今日我的打卡（最近）：{
                  myTodayLogs.length
                  ? myTodayLogs.map(l => `${l.type==='IN'?'上班':'下班'} ${fmtTime(l.ts)}`).join('、')
                  : '—'
                }
              </div>
            </div>

            <div className="mt-4">
              <div className="flex items-center justify-between gap-3 mb-2">
                <h2 className="text-lg font-semibold">今日所有人的最新上/下班</h2>
                <button onClick={loadTodayLatestIO} className="px-3 py-2 bg-slate-700 text-white rounded hover:bg-slate-800">重新整理</button>
              </div>
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="px-3 py-2 text-left">姓名</th>
                      <th className="px-3 py-2 text-left">帳號</th>
                      <th className="px-3 py-2 text-left">最新上班</th>
                      <th className="px-3 py-2 text-left">最新下班</th>
                    </tr>
                  </thead>
                  <tbody>
                    {todayLatestIO.map(r => (
                      <tr key={r.uid} className="border-t">
                        <td className="px-3 py-2">{r.displayName || '未設定'}</td>
                        <td className="px-3 py-2">{r.email || r.uid}</td>
                        <td className="px-3 py-2">
                          {r.inTs
                            ? <span className="inline-block px-2 py-1 rounded text-xs font-medium bg-emerald-100 text-emerald-800">
                                上班 {fmtTime(r.inTs)}
                              </span>
                            : <span className="text-gray-400">—</span>}
                        </td>
                        <td className="px-3 py-2">
                          {r.outTs
                            ? <span className="inline-block px-2 py-1 rounded text-xs font-medium bg-amber-100 text-amber-800">
                                下班 {fmtTime(r.outTs)}
                              </span>
                            : <span className="text-gray-400">—</span>}
                        </td>
                      </tr>
                    ))}
                    {!todayLatestIO.length && (
                      <tr><td className="px-3 py-4 text-gray-400" colSpan="4">（今天尚無資料）</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          {/* 操作列 */}
          <div className="bg-white rounded-xl shadow-lg p-5 mb-5">
            <div className="flex flex-col md:flex-row items-center justify-between gap-3">
              <div className="flex gap-2 w-full md:w-auto">
                <button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))}
                        className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">上一月</button>
                <select
                  value={`${y}-${String(m+1).padStart(2,'0')}`}
                  onChange={(e)=>{ const [yy,mm]=e.target.value.split('-'); setCurrentDate(new Date(+yy, +mm-1, 1)); }}
                  className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-auto"
                >
                  {Array.from({length:25},(_,i)=>i-12).map(off=>{
                    const d=new Date(); d.setMonth(d.getMonth()+off);
                    const v=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    return <option key={v} value={v}>{d.getFullYear()}年{d.getMonth()+1}月</option>;
                  })}
                </select>
                <button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))}
                        className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">下一月</button>
              </div>
              <div className="flex items-center gap-2 w-full md:w-auto">
                <input type="text" value={newStaffName} onChange={e=>setNewStaffName(e.target.value)}
                       placeholder="新增員工姓名"
                       className="border rounded-lg px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-green-500"/>
                <button onClick={handleAddStaff} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 whitespace-nowrap">新增</button>
                <button onClick={manualSave} className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 whitespace-nowrap">手動儲存</button>
                <button onClick={openExportWindow} className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 whitespace-nowrap">匯出月曆</button>
              </div>
            </div>

            <div className="mt-4 text-sm text-gray-700">
              <div className="flex flex-wrap gap-4">
                <div>週一～週五：09:00–22:00</div>
                <div>週六：09:00–21:00</div>
                <div>週日：09:30–21:00</div>
                <div className="text-gray-500">（行事曆格內僅顯示「姓名：班別」，合計時數依當日營業時間裁切。）</div>
              </div>
            </div>
          </div>

          {/* 月份行事曆：週一 → 週日 */}
          <div className="bg-white rounded-xl shadow-lg p-5 mb-5">
            <div className="grid grid-cols-7 gap-2 text-center text-sm text-gray-600 mb-2">
              {['一','二','三','四','五','六','日'].map(w => (
                <div key={w} className="font-semibold">{w}</div>
              ))}
            </div>

            <div className="grid grid-cols-7 gap-2">
              {calendarCells.map((d, idx) => {
                if (!d) return <div key={idx} className="min-h-[8rem] border rounded p-2 bg-gray-50"></div>;
                const date = new Date(y, m, d);
                return (
                  <div key={idx} className="min-h-[8rem] border rounded p-2 bg-white">
                    <div className="flex items-center justify-between text-xs text-gray-500 mb-1">
                      <span className="inline-block px-1.5 py-0.5 rounded bg-gray-100 border">{m+1}/{d}</span>
                      <span></span>
                    </div>
                    <div className="space-y-1 text-sm">
                      {staffs.length === 0 && <div className="text-gray-300">—</div>}
                      {staffs.map((name, si) => {
                        const val = schedule[d-1]?.[si] ?? '';
                        const t = getShiftText(val);
                        const badgeClass = SHIFT_COLOR[(typeof val==='object')?'請假':t] || SHIFT_COLOR[''];
                        return (
                          <button
                            key={name+si}
                            onClick={()=>cycleShift(d-1, si)}
                            className={`w-full text-left px-2 py-1 rounded ${badgeClass} hover:opacity-90 transition`}
                            title="點擊切換班別"
                          >
                            <span className="font-medium">{name}</span>：{t || '—'}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* 合計區 */}
          <div className="bg-white rounded-xl shadow-lg p-5 mb-16">
            <h3 className="text-lg font-semibold mb-3">本月統計</h3>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="px-3 py-2 text-left">姓名</th>
                    <th className="px-3 py-2 text-left">總天數</th>
                    <th className="px-3 py-2 text-left">總時數</th>
                    <th className="px-3 py-2 text-left">請假天數</th>
                    <th className="px-3 py-2 text-left">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {staffs.map(n => (
                    <tr key={n} className="border-t">
                      <td className="px-3 py-2">{n}</td>
                      <td className="px-3 py-2">{stats[n]?.totalDays || 0}</td>
                      <td className="px-3 py-2">{stats[n]?.totalHours || 0} 小時</td>
                      <td className="px-3 py-2">{stats[n]?.leaveDays || 0}</td>
                      <td className="px-3 py-2">
                        <button onClick={()=>handleDeleteStaff(n)} className="text-red-600 hover:underline">刪除</button>
                      </td>
                    </tr>
                  ))}
                  {!staffs.length && (
                    <tr><td className="px-3 py-4 text-gray-400" colSpan="5">尚無員工，請先新增。</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {/* 刪除員工確認 */}
          {confirmOpen && (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
                <h3 className="text-lg font-bold mb-4">確認刪除</h3>
                <p className="mb-6">是否確認刪除員工 <span className="font-semibold text-red-600">"{staffToDel}"</span>？此操作無法復原。</p>
                <div className="flex justify-center gap-3">
                  <button onClick={()=>{ setConfirmOpen(false); setStaffToDel(null); }} className="px-4 py-2 bg-gray-200 rounded-lg">取消</button>
                  <button onClick={()=>confirmDeleteStaff(staffToDel)} className="px-4 py-2 bg-red-500 text-white rounded-lg">確認刪除</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
