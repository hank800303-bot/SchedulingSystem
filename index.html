<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>排班系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.24.9/babel.min.js" crossorigin></script>
  <!-- 產生 PDF 用（html2canvas + jsPDF） -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Firebase（不含 analytics） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, onSnapshot, getDoc,
      collection, addDoc, serverTimestamp, getDocs, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    window.firebase = {
      initializeApp, getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      getFirestore, doc, setDoc, onSnapshot, getDoc,
      collection, addDoc, serverTimestamp, getDocs, query, where, limit
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
    body { font-family:'Noto Sans TC',sans-serif; }
    .scrollbar-hide::-webkit-scrollbar { display:none; }
    .scrollbar-hide { -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo, useRef } = React;

    const {
      initializeApp, getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      getFirestore, doc, setDoc, onSnapshot, getDoc,
      collection, addDoc, serverTimestamp, getDocs, query, where, limit
    } = window.firebase;

    /* ===== 版本與 App 常數 ===== */
    const CODE_VERSION = '20250922-43';
    const APP_ID = 'zhenan-scheduler';
    const WORKSPACE_ID = 'main';

    const firebaseConfig = {
      apiKey: "AIzaSyA0RjZ0RXst__qzv4e281LUOh2zdiMgmd0",
      authDomain: "zhenan-scheduler.firebaseapp.com",
      projectId: "zhenan-scheduler",
      storageBucket: "zhenan-scheduler.firebasestorage.app",
      messagingSenderId: "217165082111",
      appId: "1:217165082111:web:549c98dd09589029918bca"
    };

    // 班別循環（最後的 '' 代表空白）
    const SHIFT_OPTIONS = ['早班','早+午班','午班','午+晚班','晚班','全天','休','支援樹林','請假',''];
    const SHIFT_COLOR = {
      '早班':'bg-blue-200 text-blue-800',
      '早+午班':'bg-indigo-200 text-indigo-800',
      '午班':'bg-teal-200 text-teal-800',
      '午+晚班':'bg-purple-200 text-purple-800',
      '晚班':'bg-red-200 text-red-800',
      '全天':'bg-cyan-200 text-cyan-800',
      '休':'bg-gray-300 text-gray-800',
      '請假':'bg-rose-200 text-rose-800',
      '支援樹林':'bg-lime-200 text-lime-800',
      '': 'bg-white text-gray-500'
    };

    /* ===== 工具與時間規則 ===== */
    const toMin = (h,m=0)=> h*60+m;
    const fmtHM  = (min)=> `${String(Math.floor(min/60)).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
    const fmtHours = (mins)=> {
      const h=mins/60; return (Math.abs(h-Math.round(h))<1e-9)? `${Math.round(h)}小時` : `${(Math.round(h*2)/2).toFixed(1)}小時`;
    };
    const pad2 = (n)=> String(n).padStart(2,'0');
    const ymdLocal = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const ymLocal  = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const fmtTime = (ts)=> (ts && ts.toDate) ? ts.toDate().toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'}) : '—';
    // YYYY/MM/DD HH:mm
    const fmtYMDHM = (ts)=>{
      const d = (ts && ts.toDate) ? ts.toDate() : (ts instanceof Date ? ts : null);
      if(!d) return '—';
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const da = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mm = pad2(d.getMinutes());
      return `${y}/${m}/${da} ${hh}:${mm}`;
    };
    const debounce = (fn,delay=500)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay);} };
    const getDaysInMonth = (y,m)=> new Date(y, m+1, 0).getDate();
    const getDowName = (y,m,d)=> ['日','一','二','三','四','五','六'][ new Date(y,m,d).getDay() ];

    // 營業時間（週一～五 09:00–22:00；週六 09:00–21:00；週日 09:30–21:00）
    const getBusinessWindow = (date)=>{
      const dow=date.getDay();
      if(dow===0) return { open:toMin(9,30), close:toMin(21,0) };
      if(dow===6) return { open:toMin(9,0),  close:toMin(21,0) };
      return { open:toMin(9,0),  close:toMin(22,0) };
    };

    const getShiftWindowForDate = (date, shiftText)=>{
      const { open, close } = getBusinessWindow(date);
      const cap = (s,e)=>({ start:Math.max(open,Math.min(s,close)), end:Math.max(Math.max(open,Math.min(s,close)), Math.min(e,close)) });
      if(!shiftText || shiftText==='休' || shiftText==='請假') return { label:'0 小時', hoursMin:0 };
      if(shiftText==='支援樹林') return { label:'', hoursMin:0 };
      let target;
      switch(shiftText){
        case '早班':    target={start:open,        end:open+toMin(4)}; break;
        case '早+午班': target={start:open,        end:toMin(17,0)};   break;
        case '午班':    target={start:toMin(13,0), end:toMin(17,0)};   break;
        case '午+晚班': target={start:toMin(13,0), end:close};         break;
        case '晚班':    target={start:toMin(16,0), end:close};         break;
        case '全天':    target={start:open,        end:close};         break;
        default:        target={start:open,        end:open};
      }
      const { start, end } = cap(target.start, target.end);
      const minutes = Math.max(0, end - start);
      const label = minutes>0 ? `${fmtHM(start)} - ${fmtHM(end)} (${fmtHours(minutes)})` : '0 小時';
      return { label, hoursMin: minutes };
    };

    const getShiftText = (v)=> (typeof v==='object' && v) ? '請假' : (v||'');
    const getFullShiftDisplay = (shift, date)=>{
      const text = getShiftText(shift);
      if(!text) return '';
      if(text==='請假' && typeof shift==='object') return '請假';
      const info = getShiftWindowForDate(date, text);
      return (
        <>
          <div className="font-bold">{text}</div>
          <div className="text-xs">{info.label}</div>
        </>
      );
    };

    /* === 行事曆 HTML 產生器（友善列印 / 新視窗）=== */
    function buildCalendarHTML(y, mIndex0, staffs, schedule, exportmode = 'full'){
      const m = mIndex0 + 1;
      const esc = (s)=> String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const total = getDaysInMonth(y, mIndex0);
      const first = new Date(y, mIndex0, 1);
      const firstDowMonStart = (first.getDay() + 6) % 7; // Monday start

      const cells = [];
      for(let i=0;i<firstDowMonStart;i++) cells.push(null);
      for(let d=1; d<=total; d++) cells.push(d);
      while(cells.length % 7 !== 0) cells.push(null);

      const rows = Math.ceil(cells.length / 7);
      const bodyClass = rows >= 6 ? 'six-rows' : '';

      const renderDay = (d)=>{
        if(!d) return '';
        const items = [];
        for(let si=0; si<staffs.length; si++){
          const name = staffs[si];
          const v = (schedule && schedule[d-1] && schedule[d-1][si]) ?? '';
          const t = getShiftText(v);
          if(!t || t==='休' || t==='請假') continue;

          const tDisp = t.replace('早+午','早＋午').replace('午+晚','午＋晚');

          if (exportmode === 'full') {
            const info  = getShiftWindowForDate(new Date(y, mIndex0, d), t);
            const short = info.label ? (info.label.split(' (')[0] || '') : '';
            const line =
              '<div class="item">'
                + '<div class="row1"><span class="name">'+esc(name)+'</span> '+esc(tDisp)+'</div>'
                + (short ? '<div class="row2">'+esc(short)+'</div>' : '')
              + '</div>';
            items.push(line);
          } else {
            items.push('<div class="item"><span class="name">'+esc(name)+'</span>：'+esc(tDisp)+'</div>');
          }
        }
        return items.length ? items.join('') : '<div class="item empty">—</div>';
      };

      const cellHtml = cells.map(function(d){
        if(!d) return '<div class="cell"></div>';
        return ''
          + '<div class="cell">'
          +   '<div class="header"><span class="datepill">' + m + '/' + d + '</span><span></span></div>'
          +   renderDay(d)
          + '</div>';
      }).join('');

      const html =
      '<!doctype html>\n' +
      '<html lang="zh-TW">\n' +
      '<head>\n' +
      '<meta charset="utf-8"/>\n' +
      '<meta name="viewport" content="width=device-width, initial-scale=1.0"/>\n' +
      '<title>'+ y + '年' + (String(m).padStart(2,"0")) + '月 班表</title>\n' +
      '<style>\n' +
      '*{box-sizing:border-box}\n' +
      '@page { size: A4 landscape; margin: 8mm; }\n' +
      '@media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }\n' +
      'body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Noto Sans TC",sans-serif;margin:0;padding:8mm;color:#111;background:#fff}\n' +
      'h1{margin:0 0 3.5mm;font-size:11pt}\n' +
      '.week{display:grid;grid-template-columns:repeat(7,1fr);gap:2mm;margin-bottom:1.6mm;color:#6b7280;font-weight:600;text-align:center;font-size:9.5pt;break-after:avoid-page;page-break-after:avoid}\n' +
      '.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1.8mm;break-inside:auto;page-break-inside:auto}\n' +
      '.cell{min-height:28.5mm;border:0.3mm solid #e5e7eb;border-radius:2mm;padding:1.8mm}\n' +
      '.header{display:flex;align-items:center;justify-content:space-between}\n' +
      '.datepill{display:inline-block;font-size:9pt;color:#6b7280;border:0.3mm solid #e5e7eb;border-radius:2mm;padding:0.5mm 2mm}\n' +
      '.item{margin-top:1mm}\n' +
      '.item .row1{font-size:9.8pt;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}\n' +
      '.item .row2{font-size:8.4pt;color:#4b5563;margin-top:0.3mm}\n' +
      '.empty{color:#c7c7c7;font-size:10pt}\n' +
      'body.six-rows h1{margin:0 0 3mm;font-size:10.5pt}\n' +
      'body.six-rows .week{margin-bottom:1.2mm;font-size:9pt}\n' +
      'body.six-rows .grid{gap:1.4mm}\n' +
      'body.six-rows .cell{min-height:25.5mm;padding:1.6mm}\n' +
      'body.six-rows .item .row1{font-size:9.2pt}\n' +
      'body.six-rows .item .row2{font-size:8pt}\n' +
      '</style>\n' +
      '</head>\n' +
      '<body class="'+bodyClass+'">\n' +
      '<h1>'+ y + '年' + (String(m).padStart(2,"0")) + '月 班表</h1>\n' +
      '<div class="week"><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div></div>\n' +
      '<div class="grid">\n' + cellHtml + '\n</div>\n' +
      '</body>\n' +
      '</html>';

      return html;
    }

    /* ===== App ===== */
    function App(){
      const [db,setDb] = useState(null);
      const [auth,setAuth] = useState(null);
      const [user,setUser] = useState(null);

      const [nameModalOpen, setNameModalOpen] = useState(false);
      const [pendingPunchType, setPendingPunchType] = useState(null); // 'IN' | 'OUT'

      const [currentDate,setCurrentDate] = useState(new Date());
      const [staffs,setStaffs] = useState([]);
      const [schedule,setSchedule] = useState([]);
      const [newStaffName,setNewStaffName] = useState('');
      const [statusMessage,setStatusMessage] = useState('');
      const [error,setError] = useState('');
      const [email,setEmail] = useState(localStorage.getItem('rememberedEmail')||'');
      const [password,setPassword] = useState('');
      const [rememberEmail,setRememberEmail] = useState(!!localStorage.getItem('rememberedEmail'));

      const [nameLocked, setNameLocked] = useState(false);
      const [confirmOpen,setConfirmOpen] = useState(false);
      const [staffToDel,setStaffToDel] = useState(null);

      const [myName,setMyName] = useState('');
      const [savingName,setSavingName] = useState(false);
      const [myTodayLogs,setMyTodayLogs] = useState([]);
      const [todayLatestIO,setTodayLatestIO] = useState([]);

      const [exportOpen,setExportOpen] = useState(false);
      const exportRef = useRef(null);
      const [exportMode, setExportMode] = useState('full'); // 'full' | 'simple'

      const [attOpen,setAttOpen] = useState(false);
      const [attLoading,setAttLoading] = useState(false);
      const [attRows,setAttRows] = useState([]);
      const attRef = useRef(null);

      // 打卡明細（本月）
      const [logOpen, setLogOpen] = useState(false);
      const [logLoading, setLogLoading] = useState(false);
      const [logRows, setLogRows] = useState([]);
      const [logFilterName, setLogFilterName] = useState('');
      const [logFilterType, setLogFilterType] = useState('ALL'); // ALL | IN | OUT
      const logRef = useRef(null);

      const prevUidRef = useRef(null);
      useEffect(() => {
        const uid = user?.uid || null;
        if (prevUidRef.current !== uid) {
          setMyName('');
          setMyTodayLogs([]);
          setTodayLatestIO([]);
          setExportOpen(false);
          setAttOpen(false);
          setPendingPunchType(null);
          setNameModalOpen(false);
          setLogOpen(false); setLogRows([]);
        }
        prevUidRef.current = uid;
      }, [user?.uid]);

      /* Firebase 初始化 */
      useEffect(()=>{
